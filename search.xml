<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ä¸ºä½•åŠ è½½Soæ—¶ä¼šå‘ç”Ÿæ­»é”ï¼Ÿ</title>
      <link href="/2022/03/04/dead-lock-when-loading-so/"/>
      <url>/2022/03/04/dead-lock-when-loading-so/</url>
      
        <content type="html"><![CDATA[<h3 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h3><p>æœ€è¿‘é¡¹ç›®ä¸­é‡åˆ°ä¸€ä¸ªç¥å¥‡çš„ANRé—®é¢˜ï¼Œé‡çº§æ¯”è¾ƒå¤§ï¼Œéƒ½æ˜¯å¡åœ¨åŒä¸€ä¸ªåœ°æ–¹ã€‚</p><p>åˆçœ‹æ—¥å¿—æ˜¯ä¸»çº¿ç¨‹å¡åœ¨äº†WebviewåŠ è½½Soçš„åœ°æ–¹ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">[</span><span class="token class-name">MainThread</span><span class="token punctuation">]</span>ANR_EXCEPTION<span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1008</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1665</span><span class="token punctuation">)</span>sl<span class="token punctuation">.</span><span class="token function">m</span><span class="token punctuation">(</span>chromium<span class="token operator">-</span><span class="token class-name">TrichromeWebView</span><span class="token punctuation">.</span>apk<span class="token operator">-</span>stable<span class="token operator">-</span><span class="token number">410310633</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">)</span>sl<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>chromium<span class="token operator">-</span><span class="token class-name">TrichromeWebView</span><span class="token punctuation">.</span>apk<span class="token operator">-</span>stable<span class="token operator">-</span><span class="token number">410310633</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">)</span>sl<span class="token punctuation">.</span><span class="token function">k</span><span class="token punctuation">(</span>chromium<span class="token operator">-</span><span class="token class-name">TrichromeWebView</span><span class="token punctuation">.</span>apk<span class="token operator">-</span>stable<span class="token operator">-</span><span class="token number">410310633</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span>android_webview<span class="token punctuation">.</span></span>AwBrowserProcess</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>chromium<span class="token operator">-</span><span class="token class-name">TrichromeWebView</span><span class="token punctuation">.</span>apk<span class="token operator">-</span>stable<span class="token operator">-</span><span class="token number">410310633</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>webview<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span></span>WebViewChromiumFactoryProvider</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span>chromium<span class="token operator">-</span><span class="token class-name">TrichromeWebView</span><span class="token punctuation">.</span>apk<span class="token operator">-</span>stable<span class="token operator">-</span><span class="token number">410310633</span><span class="token operator">:</span><span class="token number">71</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>webview<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span></span>WebViewChromiumFactoryProvider</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chromium<span class="token operator">-</span><span class="token class-name">TrichromeWebView</span><span class="token punctuation">.</span>apk<span class="token operator">-</span>stable<span class="token operator">-</span><span class="token number">410310633</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>webview<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span></span>WebViewChromiumFactoryProviderForR</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chromium<span class="token operator">-</span><span class="token class-name">TrichromeWebView</span><span class="token punctuation">.</span>apk<span class="token operator">-</span>stable<span class="token operator">-</span><span class="token number">410310633</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>webview<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span></span>WebViewChromiumFactoryProviderForR</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>chromium<span class="token operator">-</span><span class="token class-name">TrichromeWebView</span><span class="token punctuation">.</span>apk<span class="token operator">-</span>stable<span class="token operator">-</span><span class="token number">410310633</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span></span>WebViewFactory</span><span class="token punctuation">.</span><span class="token function">getProvider</span><span class="token punctuation">(</span><span class="token class-name">WebViewFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">266</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span></span>CookieManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">CookieManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span></span>CookieManager</span><span class="token punctuation">.</span><span class="token function">allowFileSchemeCookies</span><span class="token punctuation">(</span><span class="token class-name">CookieManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">259</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h3><p>ä¸ºä»€ä¹ˆåŠ è½½Soä¼šè¿™ä¹ˆè€—æ—¶ï¼Ÿè¿™ä¸ªSoæœ‰ä»€ä¹ˆç‰¹æ®Šçš„ï¼Ÿè«éè¿™ä¸ªSoåŠ è½½è¶…è¿‡äº†5ç§’ï¼Ÿ</p><p>æŸ¥çœ‹æ­¤æ—¶è¿è¡Œçš„å…¶ä»–çº¿ç¨‹ï¼Œå‘ç°åŒæ—¶è¢«å¡ä½çš„ï¼Œä¸æ­¢webviewä¸€ä¸ªSoåŠ è½½çš„åœ°æ–¹ï¼Œå¦‚ä¸‹æ‰€ç¤º<br>ç«¯å†…å‡ ä¹åŠ è½½Soçš„çº¿ç¨‹éƒ½å¡ä½äº†ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token class-name">A</span><span class="token punctuation">]</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1008</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1665</span><span class="token punctuation">)</span>yo0<span class="token punctuation">.</span>j<span class="token punctuation">.</span>Ê¿<span class="token punctuation">(</span><span class="token class-name">SafelyLibraryLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>yyy<span class="token punctuation">.</span>common<span class="token punctuation">.</span>soloader<span class="token punctuation">.</span></span>SoLoaderShim</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">SoLoaderShim</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token class-name">B</span><span class="token punctuation">]</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">nativeLoad</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">nativeLoad</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1131</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1085</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1008</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1665</span><span class="token punctuation">)</span>xt0<span class="token punctuation">.</span>c<span class="token punctuation">.</span>Ê»<span class="token punctuation">(</span><span class="token class-name">LibLoadUtil</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">)</span>xt0<span class="token punctuation">.</span>c<span class="token punctuation">.</span>Ê¼<span class="token punctuation">(</span><span class="token class-name">LibLoadUtil</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">)</span>wt0<span class="token punctuation">.</span>d<span class="token punctuation">.</span>Ê¼<span class="token punctuation">(</span><span class="token class-name">StarTrailHelper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token class-name">C</span><span class="token punctuation">]</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1008</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1665</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>yyy<span class="token punctuation">.</span>est<span class="token punctuation">.</span></span>E</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>clinit<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>yyy<span class="token punctuation">.</span>est<span class="token punctuation">.</span></span>E</span><span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>yyy<span class="token punctuation">.</span></span>T</span><span class="token punctuation">.</span><span class="token function">q</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹ç°è±¡å¾ˆåƒæ˜¯å‘ç”Ÿäº†æ­»é”ï¼Œä¸è¿‡æ­»é”å‘ç”Ÿçš„åœºæ™¯æ˜¯ä¸¤ä¸ªçº¿ç¨‹ç›¸äº’ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„é”ğŸ”’ã€‚<br>æ’æŸ¥ä¸»çº¿ç¨‹è°ƒç”¨å †æ ˆåï¼Œå‘ç°é™¤äº†ç³»ç»Ÿ<code>Runtime.loadiLibrary0</code>æ–¹æ³•åŠ äº†é”ï¼Œå…¶ä»–åœ°æ–¹æ²¡æœ‰é”ã€‚</p><p><code>Runtime</code>æœ¬èº«æ˜¯å•ä¾‹ï¼Œ<code>loadLirary0</code>æ–¹æ³•æ˜¯<strong>synchronized</strong>æ–¹æ³•ï¼Œè¦è¿›å…¥è¯¥æ–¹æ³•ï¼Œéœ€è¦å½“å‰çº¿ç¨‹è·å–åˆ°<code>Runtime</code>å¯¹è±¡çš„é”ğŸ”’ã€‚<br>æŸ¥çœ‹æ•´ä¸ª<code>Runtime</code>ç±»ä¸­ï¼Œèƒ½ç«äº‰<code>Runtime</code>å¯¹è±¡é”çš„ï¼Œéƒ½æ˜¯åœ¨åŠ è½½Soç›¸å…³çš„é€»è¾‘</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> callerClass<span class="token punctuation">,</span> <span class="token class-name">String</span> libname<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>loader <span class="token keyword">instanceof</span> <span class="token class-name">BootClassLoader</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> filename <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">findLibrary</span><span class="token punctuation">(</span>libraryName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>filename <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span><span class="token punctuation">(</span>loader <span class="token operator">+</span> <span class="token string">" couldn't find \""</span> <span class="token operator">+</span>                                           <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">mapLibraryName</span><span class="token punctuation">(</span>libraryName<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> error <span class="token operator">=</span> <span class="token function">nativeLoad</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">getLibPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> filename <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">mapLibraryName</span><span class="token punctuation">(</span>libraryName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> error <span class="token operator">=</span> <span class="token function">nativeLoad</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> callerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ’æŸ¥è¿‡ç¨‹"><a href="#æ’æŸ¥è¿‡ç¨‹" class="headerlink" title="æ’æŸ¥è¿‡ç¨‹"></a>æ’æŸ¥è¿‡ç¨‹</h4><p>æ‰€ä»¥é—®é¢˜å˜æˆäº†ï¼Œæ˜¯è°æŒæœ‰äº†<code>Runtime</code>åŠ è½½Soçš„å¯¹è±¡é”ğŸ”’ï¼Œå¹¶ä¸”é•¿æ—¶é—´æ²¡æœ‰é‡Šæ”¾ã€‚</p><p>é€šè¿‡åˆ†ææ‰€æœ‰è¢«å¡åœ¨åŠ è½½Soå¤„çš„çº¿ç¨‹ï¼Œå‘ç°çº¿ç¨‹<strong>Thread B</strong>å«Œç–‘é‡å¤§</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">[</span><span class="token class-name">Thread</span> <span class="token class-name">B</span><span class="token punctuation">]</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">nativeLoad</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1131</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1085</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1008</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1665</span><span class="token punctuation">)</span>xt0<span class="token punctuation">.</span>c<span class="token punctuation">.</span>Ê»<span class="token punctuation">(</span><span class="token class-name">LibLoadUtil</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">)</span>xt0<span class="token punctuation">.</span>c<span class="token punctuation">.</span>Ê¼<span class="token punctuation">(</span><span class="token class-name">LibLoadUtil</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">)</span>wt0<span class="token punctuation">.</span>d<span class="token punctuation">.</span>Ê¼<span class="token punctuation">(</span><span class="token class-name">XXXXHelper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åªæœ‰å®ƒæˆåŠŸè·å–åˆ°äº†<code>Runtime</code>åŠ è½½Soçš„é”ï¼Œå¹¶è¿›å…¥äº†nativeæ–¹æ³•å¼€å§‹åŠ è½½Soã€‚</p><p>çœ‹å †æ ˆä¿¡æ¯ï¼Œçº¿ç¨‹<strong>Thread B</strong>æ˜¯æ­£åœ¨åŠ è½½Soï¼Œè€Œå…¶ä»–çº¿ç¨‹è¿˜åœ¨ç­‰å¾…<strong>Thread B</strong>åŠ è½½SoæˆåŠŸåé‡æ–°ç«äº‰<code>Runtime</code>çš„å¯¹è±¡é”ğŸ”’ã€‚</p><p>ä½†æ˜¯ä¸ºä»€ä¹ˆ<strong>Thread B</strong>ä¹Ÿè¢«é˜»å¡ä½ï¼Œæ²¡æœ‰å®ŒæˆSoçš„åŠ è½½ï¼Œå®ƒåœ¨ç­‰ä»€ä¹ˆï¼Ÿ</p><p>æœ‰æ²¡æœ‰å¯èƒ½æ˜¯è¿™ä¸ªSoåœ¨<code>JNI_OnLoad</code>æ–¹æ³•é‡Œæ‰§è¡Œäº†ä»€ä¹ˆè€—æ—¶æ“ä½œï¼Ÿ</p><p>é€šè¿‡è”ç³»<strong>Thread B</strong>åŠ è½½Soçš„ç»´æŠ¤å›¢é˜Ÿï¼Œå¯¹æ–¹è¡¨ç¤ºï¼Œ<code>JNI_OnLoad</code>å†…æ²¡æœ‰è€—æ—¶æ“ä½œï¼Œåªæ˜¯ä¸€äº›å¸¸è§„çš„<code>JNI</code>æ–¹æ³•æ³¨å†Œå’Œåˆå§‹åŒ–å·¥ä½œã€‚</p><p>ç„¶è€Œè¯¡å¼‚çš„æ˜¯è¿™ä¸ªSdkå·²ç»ä¸Šçº¿äº†å¥½å‡ ä¸ªç‰ˆæœ¬ï¼Œæœ€è¿‘æ²¡æœ‰æ›´æ–°ã€‚é€šè¿‡åç¼–è¯‘Apkï¼Œæ¯”å¯¹Soçš„md5ï¼Œå‘ç°ç¡®å®æ²¡æœ‰å˜åŒ–ã€‚</p><p>çº¿ç´¢åˆ°è¿™é‡Œåˆä¸­æ–­äº†ï¼Œæ²¡æœ‰äº†å¤´ç»ªã€‚</p><ul><li>çŒœæƒ³A</li></ul><p>å¦‚æœ<code>JNI_Onload</code>é‡Œåå°„è°ƒç”¨äº†å…¶ä»–çš„ç±»ï¼Œè€Œåœ¨è¿™ä¸ªç±»çš„<code>static</code>å—ä¸­åˆè§¦å‘äº†æ–°çš„SoåŠ è½½ï¼Œä¼šä¸ä¼šæ­»é”ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸ä¼šã€‚</p><p>å› ä¸ºå³æ˜¯åœ¨<code>JNI_Onload</code>é‡Œè§¦å‘äº†æ–°çš„SoåŠ è½½ï¼Œä¹Ÿæ˜¯åœ¨å½“å‰çº¿ç¨‹ï¼Œ<strong>synchronize</strong>é”æ˜¯å¯é‡å…¥é”ï¼Œå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰äº†<code>Runtime</code>å¯¹è±¡çš„é”ï¼Œ<br>å†æ¬¡è¿›å…¥<code>Runtime.loadLibrary0</code>æ–¹æ³•æ— éœ€å†ä¸å…¶ä»–çº¿ç¨‹ç«äº‰ï¼Œæ‰€ä»¥ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚</p><p>è·ŸSoçš„ç»´æŠ¤å›¢é˜Ÿä¹Ÿç¡®è®¤ï¼Œåœ¨<code>JNI_Onload</code>é‡Œä¸ä¼šè§¦å‘æ–°çš„SoåŠ è½½ã€‚</p><ul><li>çŒœæƒ³B</li></ul><p>æ—¢ç„¶<code>JNI_Onload</code>é‡Œä¸ä¼šåŠ è½½Soï¼Œé‚£ä¼šåˆå§‹åŒ–å…¶ä»–ç±»å—ï¼Ÿ<br>ç±»åˆå§‹åŒ–ä¹Ÿæ˜¯æœ‰é”çš„ï¼Œè™šæ‹Ÿæœºä¸ºäº†ä¿è¯æ¯ä¸ªç±»åªè¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œåœ¨ç±»åˆå§‹åŒ–æ—¶ä¼šåŠ é”ã€‚</p><p>å¦‚æœ</p><ol><li>çº¿ç¨‹<strong>Thread C</strong>æ­£åœ¨åˆå§‹åŒ–ç±»<strong>ClassA</strong>ï¼Œæ°å¥½<strong>ClassA</strong>çš„<strong>static</strong>å—ä¸­è§¦å‘äº†Soçš„åŠ è½½</li><li>çº¿ç¨‹<strong>Thread B</strong>çš„<code>JNI_Onload</code>æ–¹æ³•é‡Œè§¦å‘äº†<strong>ClassA</strong>çš„ç±»åˆå§‹åŒ–</li></ol><p>æ­¤æ—¶ï¼Œçº¿ç¨‹<strong>Thread C</strong>æŒæœ‰è™šæ‹Ÿæœºçš„ç±»åŠ è½½é”ï¼Œç­‰å¾…<code>Runtime</code>çš„å¯¹è±¡é”ï¼›çº¿ç¨‹<strong>Thread B</strong>æŒæœ‰<code>Runtime</code>çš„<strong>å¯¹è±¡é”</strong>ï¼Œç­‰å¾…è™šæ‹Ÿæœºçš„<strong>ç±»åŠ è½½é”</strong>ï¼Œä¾¿å‘ç”Ÿäº†æ­»é”ã€‚</p><p>æ„Ÿè§‰çœ‹åˆ°äº†ä¸€ä¸å¸Œæœ›ã€‚</p><p>å†å›å¤´åˆ†æANRçš„å †æ ˆä¿¡æ¯ï¼Œå‘ç°<strong>Thread C</strong>ç¡®å®æ­£å¤„äºç±»åˆå§‹åŒ–çš„é˜¶æ®µï¼Œå¹¶ä¸”ä¹Ÿæ­£è¢«é˜»å¡åœ¨Soçš„åŠ è½½ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token class-name">C</span><span class="token punctuation">]</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1008</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1665</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>yyy<span class="token punctuation">.</span>est<span class="token punctuation">.</span></span>E</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>clinit<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>yyy<span class="token punctuation">.</span>est<span class="token punctuation">.</span></span>E</span><span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>yyy<span class="token punctuation">.</span></span>T</span><span class="token punctuation">.</span><span class="token function">q</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é«˜äº®çš„ç¬¬å››è¡Œï¼Œ**com.xxx.yyy.est.E.<clinit>(Unknown Source:2)**ï¼Œè¯´æ˜æ­£åœ¨è¿›è¡Œç±»çš„åˆå§‹åŒ–ã€‚</clinit></p><p>ç§ç§è¿¹è±¡è¡¨æ˜ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯å‘ç”Ÿäº†<strong>çŒœæƒ³B</strong>çš„æƒ…å†µã€‚</p><p>å³çº¿ç¨‹<strong>Thread B</strong>ä¸<strong>Thread C</strong>å‘ç”Ÿäº†æ­»é”ï¼ŒåŒæ—¶ç”±äº<code>Runtime</code>åŠ è½½Soçš„é”è¢«<strong>Thread B</strong>æŒæœ‰ï¼Œå¯¼è‡´åŒ…æ‹¬ä¸»ç°åœºåœ¨å†…çš„ç«¯å†…æ‰€æœ‰åŠ è½½Soçš„çº¿ç¨‹éƒ½è¢«é˜»å¡ï¼Œ<br>è¿›è€Œå¯¼è‡´äº†ANRã€‚</p><h4 id="æ°´è½çŸ³å‡º"><a href="#æ°´è½çŸ³å‡º" class="headerlink" title="æ°´è½çŸ³å‡º"></a>æ°´è½çŸ³å‡º</h4><p>ç”±äºè¿™ä¸ªé—®é¢˜é‡çº§æ¯”è¾ƒå¤§ï¼Œç»è¿‡ä¸å‚å•†çš„æ²Ÿé€šï¼Œæ‹¿åˆ°äº†çº¿ä¸Šä¸€äº›æ—¥å¿—ã€‚</p><pre class="line-numbers language-log" data-language="log"><code class="language-log">Thread B    <span class="token operator">#</span><span class="token number">00</span> pc <span class="token number">000000000006cbbc</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/bionic/libc.so</span> <span class="token operator">(</span>syscall<span class="token operator">+</span><span class="token number">28</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">b91c775ccc9b0556e91bc575a2511cd0</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">01</span> pc <span class="token number">000000000015c2a0</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ConditionVariable<span class="token operator">:</span><span class="token operator">:</span>WaitHoldingLocks<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">156</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">08543716770b195bd10fafbe11bb5052</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">02</span> pc <span class="token number">00000000004292e4</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Monitor<span class="token operator">:</span><span class="token operator">:</span>Wait<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> long<span class="token punctuation">,</span> int<span class="token punctuation">,</span> bool<span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>ThreadState<span class="token operator">)</span><span class="token operator">+</span><span class="token number">660</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">08543716770b195bd10fafbe11bb5052</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">03</span> pc <span class="token number">000000000042af90</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Monitor<span class="token operator">:</span><span class="token operator">:</span>Wait<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>ObjPtr<span class="token operator">&lt;</span>art<span class="token operator">:</span><span class="token operator">:</span>mirror<span class="token operator">:</span><span class="token operator">:</span>Object<span class="token operator">&gt;</span><span class="token punctuation">,</span> long<span class="token punctuation">,</span> int<span class="token punctuation">,</span> bool<span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>ThreadState<span class="token operator">)</span><span class="token operator">+</span><span class="token number">284</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">08543716770b195bd10fafbe11bb5052</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">04</span> pc <span class="token number">0000000000184ef0</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ClassLinker<span class="token operator">:</span><span class="token operator">:</span>WaitForInitializeClass<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Handle<span class="token operator">&lt;</span>art<span class="token operator">:</span><span class="token operator">:</span>mirror<span class="token operator">:</span><span class="token operator">:</span>Class<span class="token operator">&gt;</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>ObjectLock<span class="token operator">&lt;</span>art<span class="token operator">:</span><span class="token operator">:</span>mirror<span class="token operator">:</span><span class="token operator">:</span>Class<span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">160</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">08543716770b195bd10fafbe11bb5052</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">05</span> pc <span class="token number">00000000001840bc</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ClassLinker<span class="token operator">:</span><span class="token operator">:</span>InitializeClass<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>Handle<span class="token operator">&lt;</span>art<span class="token operator">:</span><span class="token operator">:</span>mirror<span class="token operator">:</span><span class="token operator">:</span>Class<span class="token operator">&gt;</span><span class="token punctuation">,</span> bool<span class="token punctuation">,</span> bool<span class="token operator">)</span><span class="token operator">+</span><span class="token number">2552</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">08543716770b195bd10fafbe11bb5052</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">06</span> pc <span class="token number">000000000016e9a4</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ClassLinker<span class="token operator">:</span><span class="token operator">:</span>EnsureInitialized<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>Handle<span class="token operator">&lt;</span>art<span class="token operator">:</span><span class="token operator">:</span>mirror<span class="token operator">:</span><span class="token operator">:</span>Class<span class="token operator">&gt;</span><span class="token punctuation">,</span> bool<span class="token punctuation">,</span> bool<span class="token operator">)</span><span class="token operator">+</span><span class="token number">92</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">08543716770b195bd10fafbe11bb5052</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">07</span> pc <span class="token number">00000000003fc280</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>FindMethodID<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ScopedObjectAccess<span class="token operator">&amp;</span><span class="token punctuation">,</span> _jclass<span class="token operator">*</span><span class="token punctuation">,</span> char const<span class="token operator">*</span><span class="token punctuation">,</span> char const<span class="token operator">*</span><span class="token punctuation">,</span> bool<span class="token operator">)</span><span class="token operator">+</span><span class="token number">548</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">08543716770b195bd10fafbe11bb5052</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">08</span> pc <span class="token number">00000000003ca048</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>JNI<span class="token operator">:</span><span class="token operator">:</span>GetStaticMethodID<span class="token operator">(</span>_JNIEnv<span class="token operator">*</span><span class="token punctuation">,</span> _jclass<span class="token operator">*</span><span class="token punctuation">,</span> char const<span class="token operator">*</span><span class="token punctuation">,</span> char const<span class="token operator">*</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">680</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">08543716770b195bd10fafbe11bb5052</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">09</span> pc <span class="token number">00000000000136f4</span>  <span class="token file-path string">/data/app/com.xxx.yyys-0FVA4L2VSdb5GXWYPpaZFA==/lib/arm64/libest.so</span> <span class="token operator">(</span>entry_est<span class="token operator">+</span><span class="token number">1284</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> feb2c1dcd5b5117d0e451dacb4be53ceb1a3c5fe<span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">10</span> pc <span class="token number">000000000000dffc</span>  <span class="token file-path string">/data/app/com.xxx.yyys-0FVA4L2VSdb5GXWYPpaZFA==/lib/arm64/libest.so</span> <span class="token operator">(</span>JNI_OnLoad<span class="token operator">+</span><span class="token number">160</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> feb2c1dcd5b5117d0e451dacb4be53ceb1a3c5fe<span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">11</span> pc <span class="token number">000000000039726c</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>JavaVMExt<span class="token operator">:</span><span class="token operator">:</span>LoadNativeLibrary<span class="token operator">(</span>_JNIEnv<span class="token operator">*</span><span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>__1<span class="token operator">:</span><span class="token operator">:</span>basic_string<span class="token operator">&lt;</span>char<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>__1<span class="token operator">:</span><span class="token operator">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">&gt;</span><span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>__1<span class="token operator">:</span><span class="token operator">:</span>allocator<span class="token operator">&lt;</span>char<span class="token operator">&gt;</span><span class="token operator">&gt;</span> const<span class="token operator">&amp;</span><span class="token punctuation">,</span> _jobject<span class="token operator">*</span><span class="token punctuation">,</span> _jclass<span class="token operator">*</span><span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>__1<span class="token operator">:</span><span class="token operator">:</span>basic_string<span class="token operator">&lt;</span>char<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>__1<span class="token operator">:</span><span class="token operator">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">&gt;</span><span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>__1<span class="token operator">:</span><span class="token operator">:</span>allocator<span class="token operator">&lt;</span>char<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">3412</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">08543716770b195bd10fafbe11bb5052</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">12</span> pc <span class="token number">0000000000005174</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libopenjdkjvm.so</span> <span class="token operator">(</span>JVM_NativeLoad<span class="token operator">+</span><span class="token number">552</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">32291dbf2a17e91f03e5b077fb50c9fe</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">13</span> pc <span class="token number">00000000000efaf4</span>  <span class="token file-path string">/system/framework/arm64/boot.oat</span> <span class="token operator">(</span>art_jni_trampoline<span class="token operator">+</span><span class="token number">228</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token number">8fb9eb57b3ea725573d56f165d17f78dd54965d7</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">14</span> pc <span class="token number">0000000000110a5c</span>  <span class="token file-path string">/system/framework/arm64/boot.oat</span> <span class="token operator">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>loadLibrary0<span class="token operator">+</span><span class="token number">236</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token number">8fb9eb57b3ea725573d56f165d17f78dd54965d7</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">15</span> pc <span class="token number">0000000000112164</span>  <span class="token file-path string">/system/framework/arm64/boot.oat</span> <span class="token operator">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>loadLibrary0<span class="token operator">+</span><span class="token number">180</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token number">8fb9eb57b3ea725573d56f165d17f78dd54965d7</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">16</span> pc <span class="token number">0000000000117b20</span>  <span class="token file-path string">/system/framework/arm64/boot.oat</span> <span class="token operator">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>System<span class="token punctuation">.</span>loadLibrary<span class="token operator">+</span><span class="token number">96</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token number">8fb9eb57b3ea725573d56f165d17f78dd54965d7</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">17</span> pc <span class="token number">00000000016f1fc4</span>  <span class="token file-path string">/data/app/com.xxx.yyys-0FVA4L2VSdb5GXWYPpaZFA==/oat/arm64/base.odex</span> <span class="token operator">(</span>or0<span class="token punctuation">.</span>c<span class="token punctuation">.</span>Ê»<span class="token operator">+</span><span class="token number">116</span><span class="token operator">)</span>Thread C    <span class="token operator">#</span><span class="token number">00</span> pc <span class="token number">000000000006cbbc</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/bionic/libc.so</span> <span class="token operator">(</span>syscall<span class="token operator">+</span><span class="token number">28</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">b91c775ccc9b0556e91bc575a2511cd0</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">01</span> pc <span class="token number">000000000015c2a0</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ConditionVariable<span class="token operator">:</span><span class="token operator">:</span>WaitHoldingLocks<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">156</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">02</span> pc <span class="token number">000000000015dfb8</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>PiConditionVariable<span class="token operator">:</span><span class="token operator">:</span>WaitHoldingLocks<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">260</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">03</span> pc <span class="token number">0000000000424f44</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>_ZN3art7Monitor4LockILNS_10LockReasonE1EEEvPNS_6ThreadE<span class="token operator">+</span><span class="token number">1928</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">04</span> pc <span class="token number">000000000042aaf0</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Monitor<span class="token operator">:</span><span class="token operator">:</span>MonitorEnter<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>ObjPtr<span class="token operator">&lt;</span>art<span class="token operator">:</span><span class="token operator">:</span>mirror<span class="token operator">:</span><span class="token operator">:</span>Object<span class="token operator">&gt;</span><span class="token punctuation">,</span> bool<span class="token operator">)</span><span class="token operator">+</span><span class="token number">976</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">05</span> pc <span class="token number">00000000005bb010</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>artLockObjectFromCode<span class="token operator">+</span><span class="token number">32</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">06</span> pc <span class="token number">00000000001477e4</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art_quick_lock_object_no_inline<span class="token operator">+</span><span class="token number">52</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">07</span> pc <span class="token number">00000000001109bc</span>  <span class="token file-path string">/system/framework/arm64/boot.oat</span> <span class="token operator">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>loadLibrary0<span class="token operator">+</span><span class="token number">76</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> c6616f9f679ad7292beda02de1246df662f7f266<span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">08</span> pc <span class="token number">0000000000112164</span>  <span class="token file-path string">/system/framework/arm64/boot.oat</span> <span class="token operator">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>loadLibrary0<span class="token operator">+</span><span class="token number">180</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> c6616f9f679ad7292beda02de1246df662f7f266<span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">09</span> pc <span class="token number">0000000000117b20</span>  <span class="token file-path string">/system/framework/arm64/boot.oat</span> <span class="token operator">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>System<span class="token punctuation">.</span>loadLibrary<span class="token operator">+</span><span class="token number">96</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> c6616f9f679ad7292beda02de1246df662f7f266<span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">10</span> pc <span class="token number">00000000001475b8</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art_quick_invoke_static_stub<span class="token operator">+</span><span class="token number">568</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">11</span> pc <span class="token number">00000000001561d4</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ArtMethod<span class="token operator">:</span><span class="token operator">:</span>Invoke<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> unsigned int<span class="token operator">*</span><span class="token punctuation">,</span> unsigned int<span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>JValue<span class="token operator">*</span><span class="token punctuation">,</span> char const<span class="token operator">*</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">284</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">12</span> pc <span class="token number">00000000002fd900</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>interpreter<span class="token operator">:</span><span class="token operator">:</span>ArtInterpreterToCompiledCodeBridge<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>ArtMethod<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>ShadowFrame<span class="token operator">*</span><span class="token punctuation">,</span> unsigned short<span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>JValue<span class="token operator">*</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">384</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">13</span> pc <span class="token number">00000000002f8bd0</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>bool art<span class="token operator">:</span><span class="token operator">:</span>interpreter<span class="token operator">:</span><span class="token operator">:</span>DoCall<span class="token operator">&lt;</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token operator">&gt;</span><span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ArtMethod<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>ShadowFrame<span class="token operator">&amp;</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>Instruction const<span class="token operator">*</span><span class="token punctuation">,</span> unsigned short<span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>JValue<span class="token operator">*</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">912</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">14</span> pc <span class="token number">00000000005ce108</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>MterpInvokeStatic<span class="token operator">+</span><span class="token number">368</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">15</span> pc <span class="token number">0000000000141994</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>mterp_op_invoke_static<span class="token operator">+</span><span class="token number">20</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">16</span> pc <span class="token number">00000000020f1494</span>  <span class="token file-path string">/data/app/com.xxx.yyy-O_XmVEkRKPw5wrtfpQ3R2w==/oat/arm64/base.vdex</span> <span class="token operator">(</span>com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>yyy<span class="token punctuation">.</span>est<span class="token punctuation">.</span>E<span class="token punctuation">.</span><span class="token operator">&lt;</span>clinit<span class="token operator">&gt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">17</span> pc <span class="token number">00000000002ce22c</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>_ZN3art11interpreterL7ExecuteEPNS_6ThreadERKNS_20CodeItemDataAccessorERNS_11ShadowFrameENS_6JValueEbb<span class="token punctuation">.</span>llvm<span class="token punctuation">.</span>10887373532384510885<span class="token operator">+</span><span class="token number">320</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">18</span> pc <span class="token number">00000000005bc090</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>artQuickToInterpreterBridge<span class="token operator">+</span><span class="token number">1012</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">19</span> pc <span class="token number">0000000000150468</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art_quick_to_interpreter_bridge<span class="token operator">+</span><span class="token number">88</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">20</span> pc <span class="token number">00000000001475b8</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art_quick_invoke_static_stub<span class="token operator">+</span><span class="token number">568</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">21</span> pc <span class="token number">00000000001561d4</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ArtMethod<span class="token operator">:</span><span class="token operator">:</span>Invoke<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> unsigned int<span class="token operator">*</span><span class="token punctuation">,</span> unsigned int<span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>JValue<span class="token operator">*</span><span class="token punctuation">,</span> char const<span class="token operator">*</span><span class="token operator">)</span><span class="token operator">+</span><span class="token number">284</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">22</span> pc <span class="token number">0000000000183e70</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ClassLinker<span class="token operator">:</span><span class="token operator">:</span>InitializeClass<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>Handle<span class="token operator">&lt;</span>art<span class="token operator">:</span><span class="token operator">:</span>mirror<span class="token operator">:</span><span class="token operator">:</span>Class<span class="token operator">&gt;</span><span class="token punctuation">,</span> bool<span class="token punctuation">,</span> bool<span class="token operator">)</span><span class="token operator">+</span><span class="token number">1964</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">23</span> pc <span class="token number">000000000016e9a4</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>ClassLinker<span class="token operator">:</span><span class="token operator">:</span>EnsureInitialized<span class="token operator">(</span>art<span class="token operator">:</span><span class="token operator">:</span>Thread<span class="token operator">*</span><span class="token punctuation">,</span> art<span class="token operator">:</span><span class="token operator">:</span>Handle<span class="token operator">&lt;</span>art<span class="token operator">:</span><span class="token operator">:</span>mirror<span class="token operator">:</span><span class="token operator">:</span>Class<span class="token operator">&gt;</span><span class="token punctuation">,</span> bool<span class="token punctuation">,</span> bool<span class="token operator">)</span><span class="token operator">+</span><span class="token number">92</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">24</span> pc <span class="token number">00000000005bf8dc</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>artQuickResolutionTrampoline<span class="token operator">+</span><span class="token number">3140</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">25</span> pc <span class="token number">00000000001501e8</span>  <span class="token file-path string">/apex/com.android.runtime/lib64/libart.so</span> <span class="token operator">(</span>art_quick_resolution_trampoline<span class="token operator">+</span><span class="token number">88</span><span class="token operator">)</span> <span class="token operator">(</span>BuildId<span class="token operator">:</span> <span class="token hash constant">691979e9d66dfedf3fd32d27da323a02</span><span class="token operator">)</span>    <span class="token operator">#</span><span class="token number">26</span> pc <span class="token number">0000000000cc7d6c</span>  <span class="token file-path string">/data/app/com.xxx.yyy-O_XmVEkRKPw5wrtfpQ3R2w==/oat/arm64/base.odex</span> <span class="token operator">(</span>com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>yyy<span class="token punctuation">.</span>T<span class="token punctuation">.</span>q<span class="token operator">+</span><span class="token number">316</span><span class="token operator">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡æ—¥å¿—ï¼Œå¯ä»¥å¾ˆæ˜¾ç¤ºçœ‹åˆ°å‘ç”Ÿæ­»é”çš„åœ°æ–¹ï¼Œä¸çŒœæµ‹Bä¸€è‡´ï¼Œè‡³æ­¤çº¿ä¸Šé‡çº§Top 1çš„ANRé—®é¢˜ç»ˆäºæ°´è½çŸ³å‡ºã€‚</p><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p>å®šä½åˆ°é—®é¢˜åï¼Œè§£å†³æ–¹æ¡ˆå°±å¾ˆç®€å•äº†ï¼Œè”ç³»å¯¹æ–¹Sdkå›¢é˜Ÿï¼Œè°ƒæ•´Soçš„åŠ è½½ç­–ç•¥ï¼š</p><ul><li>é¿å…åœ¨ç±»çš„<strong>static</strong>å—ä¸­åŠ è½½Soï¼Œå¯å•ç‹¬æ”¾åœ¨initæ–¹æ³•ä¸­</li><li>é¿å…åœ¨Soçš„<code>JNI_OnLoad</code>ä¸­æ‰§è¡Œè§¦å‘ç±»åˆå§‹åŒ–çš„æ“ä½œ</li></ul>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dead lock </tag>
            
            <tag> æ­»é” </tag>
            
            <tag> anr </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kotlin coroutineå…¥é—¨</title>
      <link href="/2022/02/28/kotlin-coroutine-basic/"/>
      <url>/2022/02/28/kotlin-coroutine-basic/</url>
      
        <content type="html"><![CDATA[<h3 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h3><p>å®¢æˆ·ç«¯å¼€å‘ï¼Œæ— è®ºæ˜¯Androidã€iOSæˆ–æ˜¯Windowsï¼Œä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰éœ€è¦åŠæ—¶ç›¸åº”ç”¨æˆ·çš„è¾“å…¥æ“ä½œï¼Œæ‰èƒ½ä¿è¯ç”¨æˆ·æ»‘åŠ¨ã€ç§»åŠ¨é¼ æ ‡æ—¶çš„æµç•…ä½“éªŒã€‚<br>è¿™è¦æ±‚ä¸»çº¿ç¨‹ä¸èƒ½æœ‰å ç”¨CPUçš„è€—æ—¶è®¡ç®—ï¼Œæˆ–è€…IOç­‰é˜»å¡æ“ä½œã€‚</p><p>å¼€å‘è¿‡ç¨‹ä¸­ä¸ºäº†é¿å…UIçº¿ç¨‹è¢«è€—æ—¶æ“ä½œé˜»å¡ï¼Œéœ€è¦åœ¨å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œè€—æ—¶æ“ä½œï¼Œç„¶åé€šè¿‡callbacké€šçŸ¥UIçº¿ç¨‹åˆ·æ–°ç•Œé¢ã€‚ä¸€äº›å¤æ‚çš„é¡µé¢éœ€è¦åµŒå¥—å¾ˆå¤šå±‚callbackï¼Œé€ æˆäº†<a href="https://callbackhell.com/">callback hell</a>ã€‚</p><p>callbackçš„æ–¹æ¡ˆæ—¢ä¸ç¬¦åˆäººç±»çš„ç›´è§‚æ€ç»´æ–¹å¼ï¼Œè®©ä»£ç ä¹Ÿå˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚</p><p><a href="https://github.com/ReactiveX/RxJava">RxJava</a>çš„è¯ç”Ÿï¼Œé€šè¿‡è§‚å¯Ÿ/è®¢é˜…çš„æ€è·¯ï¼Œç»“åˆé“¾å¼è°ƒç”¨ï¼Œä¼˜é›…çš„è§£å†³äº†callback hellçš„é—®é¢˜ã€‚</p><p>éšç€Kotlinåœ¨Androidä¸Šçš„æˆåŠŸæ¨å¹¿ï¼Œå¦‚ä»Šå¼‚æ­¥ä»»åŠ¡æœ‰äº†æ›´åº•å±‚ã€æ›´è½»é‡çš„æ–°æ–¹æ¡ˆï¼š<a href="https://kotlinlang.org/docs/coroutines-basics.html">Kotlin Coroutine</a></p><h3 id="ä»€ä¹ˆæ˜¯Coroutine"><a href="#ä»€ä¹ˆæ˜¯Coroutine" class="headerlink" title="ä»€ä¹ˆæ˜¯Coroutine"></a>ä»€ä¹ˆæ˜¯Coroutine</h3><blockquote><p>ä»¥ä¸‹ç‰¹æŒ‡Kotlin Coroutineçš„æ¦‚å¿µ</p></blockquote><ul><li><p>coroutineï¼š<br>å¹¿ä¹‰ä¸Šï¼Œä¸€ç§å¹¶å‘è®¾è®¡ï¼Œé€šè¿‡æ‰§è¡Œä¸€æ®µå¯è¢«æŒ‚èµ·ï¼ˆè°ƒç”¨suspendæ–¹æ³•ï¼‰ï¼Œæ¢å¤(suspendæ–¹æ³•æ‰§è¡Œå®Œæ¯•)çš„ä»£ç ï¼Œç®€åŒ–å¹¶å‘é€»è¾‘ã€‚<br>ç‹­ä¹‰ä¸Šï¼ŒCoroutineå¯¹è±¡å¯ä»¥è¿‘ä¼¼è®¤ä¸ºæ˜¯æ”¯æŒäº†startã€resumeã€cancelçš„Runnableå¯¹è±¡ï¼ŒKotlinçš„Coroutineç±»å®ç°äº†Jobæ¥å£ã€‚</p></li><li><p>suspendæ–¹æ³•ï¼š<br>è¢«suspendå…³é”®å­—ä¿®é¥°çš„æ–¹æ³•ï¼Œ<strong>æç¤º</strong>å½“å‰æ–¹æ³•å¯èƒ½é˜»å¡è°ƒç”¨æ–¹ã€‚åªèƒ½åœ¨CoroutineScope æˆ–å…¶ä»–suspendæ–¹æ³•ä¸­è°ƒç”¨ã€‚</p></li><li><p>æ€ä¹ˆæŒ‚èµ·ï¼Ÿ<br>è°ƒç”¨suspendæ–¹æ³•ã€‚</p></li><li><p>æ€ä¹ˆæ¢å¤ï¼Ÿ<br>ç¼–è¯‘å™¨ä¸€ä¸ªäººé»˜é»˜æ‰›ä¸‹äº†æ‰€æœ‰ã€‚åœ¨ç¼–è¯‘é˜¶æ®µï¼Œä¼šæŠŠsuspendä¹‹åçš„ä»£ç å—å°è£…ä¸ºContinuationä½œä¸ºå‚æ•°æ³¨å…¥åŸsuspendæ–¹æ³•ï¼Œä»¥å®ç°resumeèƒ½åŠ›ã€‚<br>ç›¸å½“äºç¼–è¯‘å™¨è‡ªåŠ¨ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†callbackã€‚</p></li><li><p>è¿è¡Œåˆ°suspendæ–¹æ³•ï¼ˆæŒ‚èµ·ï¼‰æ—¶å½“å‰çº¿ç¨‹æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ<br>RunningçŠ¶æ€ï¼Œç»§ç»­è¿è¡Œè°ƒç”¨suspendæ–¹æ³•ä¹‹å¤–çš„ä»£ç ã€‚</p></li></ul><h3 id="å¦‚ä½•ä½¿ç”¨Coroutine"><a href="#å¦‚ä½•ä½¿ç”¨Coroutine" class="headerlink" title="å¦‚ä½•ä½¿ç”¨Coroutine"></a>å¦‚ä½•ä½¿ç”¨Coroutine</h3><p>ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š</p><ul><li>launch<br>åˆ›å»ºä¸€ä¸ªæ–°çš„coroutineå¹¶æ‰§è¡Œï¼Œ<strong>ä¸å…³å¿ƒè¿”å›å€¼</strong></li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span> <span class="token comment">// this: CoroutineScope</span>    launch <span class="token punctuation">{</span> <span class="token comment">// launch a new coroutine and continue</span>        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span> <span class="token comment">// non-blocking delay for 1 second (default time unit is ms)</span>        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"World!"</span></span><span class="token punctuation">)</span> <span class="token comment">// print after delay</span>    <span class="token punctuation">}</span>    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Hello"</span></span><span class="token punctuation">)</span> <span class="token comment">// main coroutine continues while a previous one is delayed</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>async</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>    <span class="token keyword">val</span> retDefer <span class="token operator">=</span> async <span class="token punctuation">{</span>          <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>          <span class="token string-literal singleline"><span class="token string">"from async return"</span></span>      <span class="token punctuation">}</span>    <span class="token keyword">val</span> ret <span class="token operator">=</span> retDefer<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">println</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token comment">// "from async return"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºæ–°çš„coroutineå¹¶æ‰§è¡Œï¼Œ<strong>å…³å¿ƒè¿”å›å€¼</strong></p><p><img src="/medias/images/launch_vs_async.png" alt="launch vs async"></p><h4 id="Structured-Concurrency"><a href="#Structured-Concurrency" class="headerlink" title="Structured Concurrency"></a>Structured Concurrency</h4><p>ç»“æ„åŒ–å¹¶å‘ï¼Œcoroutineä¸åŒäºThreadï¼Œæœ‰å±‚çº§ç»“æ„ã€‚</p><p>Javaä¸­çš„Threadåªæœ‰Groupçš„æ¦‚å¿µï¼Œæ²¡æœ‰çˆ¶å­å…³ç³»ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯åŒä¸€çº§çš„ï¼Œæ˜¯å…„å¼Ÿå…³ç³»ã€‚ä¸€ä¸ªçº¿ç¨‹çš„æ­»æ´»ã€å¼‚å¸¸ï¼Œä¸å½±å“åˆ«çš„çº¿ç¨‹ã€‚</p><p>coroutineæ˜¯æœ‰çˆ¶å­æ¦‚å¿µçš„ï¼Œçˆ¶coroutineè¢«cancelï¼Œå­çš„coroutineä¹Ÿä¼šè¢«cancelï¼ˆå¦‚æœæ­£ç¡®çš„å®ç°ï¼‰ã€‚å­coroutineå¦‚æœæœ‰å¼‚å¸¸ï¼Œä¼šä¼ æ’­ç»™çˆ¶coroutineï¼Œ<br>è¿›è€Œå½±å“å…¶ä»–å…„å¼Ÿcoroutineçš„æ‰§è¡Œã€‚</p><p>Kotlin Coroutineéµå¾ªStructured Concurrencyè®¾è®¡è§„èŒƒï¼Œé€šè¿‡Scopeå¯ä»¥è·Ÿè¸ªæ¯ä¸ªcorouineçš„æ‰§è¡Œï¼Œç¡®ä¿ä¸ä¼šæ³„éœ²ã€ä¸¢å¤±ã€‚</p><h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><p>ä¸€ä¸ªSetï¼Œä¿å­˜äº†coroutineçš„åŸºç¡€ä¿¡æ¯ï¼š</p><ul><li>CoroutineDispatcher åç¨‹è¿è¡Œçš„Dispatcherï¼ˆçº¿ç¨‹ï¼‰</li><li>CoroutineExceptionHandler å¼‚å¸¸åçš„å¤„ç†æ–¹æ³•</li><li>CoroutineName åç¨‹çš„åå­—</li><li>Job åç¨‹æœ¬ä½“</li></ul><p><img src="/medias/images/coroutine_context.png" alt="coroutineContext"></p><h4 id="Dispatcher"><a href="#Dispatcher" class="headerlink" title="Dispatcher"></a>Dispatcher</h4><p>æ§åˆ¶coroutineè¿è¡Œçš„çº¿ç¨‹ï¼Œå®ç°çº¿ç¨‹çš„åˆ‡æ¢ã€‚</p><ul><li>Dispatcher.Main ä¸»çº¿ç¨‹ï¼ŒUIçº¿ç¨‹</li><li>Dispatcher.IO IOçº¿ç¨‹æ± ï¼Œ2ä¸ªcoreçº¿ç¨‹ï¼Œæœ€å¤§çº¿ç¨‹æ•°max(64, cpu cores)</li><li>Dispatcher.Default é»˜è®¤çº¿ç¨‹æ± ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºCPUæ ¸æ•°</li></ul><h4 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h4><p>åç¨‹æœ¬ä½“ï¼Œå¢å¼ºç‰ˆçš„Runnableã€‚æœ‰startã€cancelã€resumeçš„èƒ½åŠ›ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœå•ä¸ªJobå‘ç”Ÿå¼‚å¸¸ï¼Œä¼šä¼ æ’­ç»™çˆ¶Jobï¼Œå¯¼è‡´å…¶ä»–å…„å¼ŸJobè¢«cancelã€‚<br><img src="/medias/images/job_when_exception.png" alt="Job When Exception"></p><p><strong>SupervisorJob</strong>å¯ä»¥æŠŠå¼‚å¸¸æ§åˆ¶åœ¨è‡ªå·±çš„èŒƒå›´å‘¢<br><img src="/medias/images/supervisor_job.png" alt="SupervisorJob"></p><h4 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h4><p>åç¨‹çš„ä½œç”¨åŸŸã€‚å¾€å¾€Scopeå†…ä¼šæœ‰å¤šä¸ªcoroutineæ‰§è¡Œï¼Œscopeç”¨æ¥ç»Ÿä¸€è·Ÿè¸ªã€ç®¡ç†æ¯ä¸ªcoroutineï¼Œæ§åˆ¶corountineçš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å­coroutineã€‚</p><p>ScopeæŒæœ‰Context</p><ul><li><p>åˆ›å»ºcoroutine<br>Corotineçš„æ„é€ å‡½æ•°éƒ½æ˜¯æœªå¼€æ”¾çš„ï¼Œåªèƒ½é€šè¿‡scopeçš„launch/asyncæ‰©å±•æ–¹æ³•åˆ›å»ºã€‚launchæ–¹æ³•è¿”å›Jobå¯¹è±¡ï¼Œasyncæ–¹æ³•è¿”å›Deferredå¯¹è±¡ï¼Œå¯æ§åˆ¶å•ä¸ªcoroutineçš„ç”Ÿå‘½å‘¨æœŸ</p></li><li><p>å¼‚å¸¸å¤„ç†<br>exceptionHandlerï¼Œå¤„ç†æ–¹æ³•ç±»ä¼¼Thread.uncaughtExceptionHandler</p></li><li><p>å–æ¶ˆ<br>scope.cancel()ï¼Œå–æ¶ˆå½“å‰scopeä¸‹çš„æ‰€æœ‰coroutineã€‚<br>æ³¨æ„ï¼škotlinx.coroutinesåŒ…ä¸‹çš„æ‰€æœ‰suspendæ–¹æ³•éƒ½æ˜¯å¯ä»¥è¢«cancelçš„ï¼Œä½†å¦‚æœæœ‰è‡ªå®šä¹‰çš„suspendæ–¹æ³•ï¼Œéœ€è¦é€šè¿‡åä½œçš„æ–¹å¼æ‰èƒ½è¢«cancelæ‰ã€‚<br>å¦‚è°ƒç”¨<code>ensureActive()</code>æ–¹æ³•ï¼š</p></li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">mySuspendFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>file <span class="token keyword">in</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ensureActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// check point</span>        file<span class="token punctuation">.</span><span class="token function">readText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¸¸ç”¨çš„Scopeï¼š<ul><li>ViewModelScope<br>AndroidXä¸­ViewModelæ‰©å±•å±æ€§ï¼ŒViewModel clearæ—¶è‡ªåŠ¨cancelã€‚é»˜è®¤è¿è¡Œåœ¨ä¸»çº¿ç¨‹</li><li>LifecycleScope<br>AndroidXä¸­LifecycleOwneræ‰©å±•å±æ€§ï¼ŒLifecyleOwner Destroyæ—¶ï¼Œè‡ªåŠ¨cancelã€‚æä¾›äº†<code>launchWhenCreated</code>ã€<code>launchWhenResumed</code>ã€<code>launchWhenStarted</code>çš„ä¾¿åˆ©æ–¹æ³•</li><li>GlobalScope<br>å…¨å±€Scopeï¼Œæ…ç”¨ï¼Œéœ€è¦è‡ªå·±å…³æ³¨ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢coroutineæ³„éœ²</li></ul></li></ul><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul><li><a href="https://kotlinlang.org/docs/coroutines-basics.html">Coroutines Basics</a></li><li><a href="https://www.youtube.com/watch?v=ZTDXo0-SKuU&amp;list=PLWz5rJ2EKKc-DpJGklgEE_w3kTO847Uxx">Kotlin Coroutines 101 - Android Conference Talks</a></li><li><a href="https://www.youtube.com/watch?v=IQf-vtIC-Uc&amp;list=PLWz5rJ2EKKc-DpJGklgEE_w3kTO847Uxx&amp;index=2">Suspend functions - Kotlin Vocabulary</a></li><li><a href="https://www.youtube.com/watch?v=FWxeDqM_WIU">Android Code-Along: Kotlin coroutines</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kotlin </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kotlin </tag>
            
            <tag> coroutine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android PluginManager æºç è§£æ4--ActivityOverider</title>
      <link href="/2015/08/12/android-pluginmanager-source-code-analysis-4/"/>
      <url>/2015/08/12/android-pluginmanager-source-code-analysis-4/</url>
      
        <content type="html"><![CDATA[<h2 id="ActivityOverideræ¦‚è¿°"><a href="#ActivityOverideræ¦‚è¿°" class="headerlink" title="ActivityOverideræ¦‚è¿°"></a>ActivityOverideræ¦‚è¿°</h2><p><code>ActivityOverider</code>è´Ÿè´£ä¸åŠ¨æ€ç”Ÿæˆçš„<code>PluginActivity</code>äº¤äº’ã€‚</p><p><code>ActivityOverider</code>ä¸»è¦å¹²äº†3ä»¶äº‹ï¼š</p><ul><li>ä¿®æ­£StartActivityçš„Intent</li><li>åŠ¨æ€ç”Ÿæˆ<code>PluginActivity</code>çš„Dexæ–‡ä»¶</li><li>å¤„ç†<code>PluginActivity</code>ç”Ÿå‘½å‘¨æœŸçš„å›è°ƒï¼Œæ ¹æ®éœ€è¦åšä¸€äº›ç‰¹æ®Šå¤„ç†</li></ul><h2 id="overrideStartActivityForResultæ–¹æ³•è§£æ"><a href="#overrideStartActivityForResultæ–¹æ³•è§£æ" class="headerlink" title="overrideStartActivityForResultæ–¹æ³•è§£æ"></a>overrideStartActivityForResultæ–¹æ³•è§£æ</h2><p>ç”±äºæ’ä»¶å†…çš„Activityæ²¡æœ‰åœ¨<code>AndroidManifest.xml</code>ä¸­æ³¨å†Œï¼Œåªæ³¨å†Œäº†<code>androidx.pluginmgr.PluginActivity</code>ï¼Œå½“é€šè¿‡<code>Context.startActivtiyForResult()</code>è°ƒèµ·ç›®æ ‡Activityæ—¶ä¼šæ‰¾ä¸åˆ°ï¼Œæ‰€ä»¥éœ€è¦å¯¹ç³»ç»Ÿçš„<code>Context.startActivtiyForResult()</code>è¿›è¡ŒåŠ«æŒï¼ŒæŠŠè¦å¯åŠ¨çš„ActivityæŒ‡å‘<code>androidx.pluginmgr.PluginActivity</code>ï¼Œå½“åŠ è½½<code>PluginActivity</code>æ—¶ï¼Œé€šè¿‡<code>FrameworkClassLoader.loadClass()</code>æ–¹æ³•å†æŠŠç±»çš„åŠ è½½è·¯å¾„ä¿®æ­£å›ç›®æ ‡Activityï¼Œå¯¹ç³»ç»Ÿè¿›è¡Œäº†ä¸€ä¸ªç’å¤©è¿‡æµ·ï¼Œéª—è¿‡å•çº¯çš„ç³»ç»Ÿï¼Œå“ˆå“ˆã€‚</p><p>startActivityå¯èƒ½å¯åŠ¨çš„æ˜¯æ’ä»¶å†…éƒ¨çš„Activityï¼Œä¹Ÿå¯èƒ½æ˜¯å®¿ä¸»çš„Activityï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶å®ƒæ’ä»¶çš„Activityï¼Œè¿™ä¸€åˆ‡éƒ½äº¤ç”±<code>overrideStartActivityForResult()</code>æ–¹æ³•å¤„ç†ã€‚</p><span id="more"></span><ul><li><h3 id="å¯åŠ¨æ˜ç¡®æŒ‡å®šç±»åçš„Activity"><a href="#å¯åŠ¨æ˜ç¡®æŒ‡å®šç±»åçš„Activity" class="headerlink" title="å¯åŠ¨æ˜ç¡®æŒ‡å®šç±»åçš„Activity"></a>å¯åŠ¨æ˜ç¡®æŒ‡å®šç±»åçš„Activity</h3></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// å–å‡ºComponentName</span><span class="token class-name">ComponentName</span> compname <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å–åŒ…å</span><span class="token class-name">String</span> pkg <span class="token operator">=</span> compname<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å–Activityç±»å</span><span class="token class-name">String</span> toActName <span class="token operator">=</span> compname<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ ¹æ®æ’ä»¶idå–ç¼“å­˜PluginInfo</span><span class="token class-name">PlugInfo</span> thisPlugin <span class="token operator">=</span> mgr<span class="token punctuation">.</span><span class="token function">getPluginById</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ActivityInfo</span> actInThisApk <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token class-name">PlugInfo</span> plug <span class="token operator">=</span> thisPlugin<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// å¯åŠ¨åŒä¸€æ’ä»¶å†…çš„Activity</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>thisPlugin<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>actInThisApk <span class="token operator">=</span> thisPlugin<span class="token punctuation">.</span><span class="token function">findActivityByClassName</span><span class="token punctuation">(</span>toActName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¯åŠ¨å¦ä¸€æ’ä»¶å†…çš„Activity</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token class-name">PlugInfo</span> otherPlug <span class="token operator">=</span> mgr<span class="token punctuation">.</span><span class="token function">getPluginByPackageName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>otherPlug <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>plug <span class="token operator">=</span> otherPlug<span class="token punctuation">;</span>actInThisApk <span class="token operator">=</span> otherPlug<span class="token punctuation">.</span><span class="token function">findActivityByClassName</span><span class="token punctuation">(</span>toActName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">// å®¹é”™å¤„ç†ï¼Œå¯åŠ¨åŒä¸€æ’ä»¶å†…çš„Activity</span>actInThisApk <span class="token operator">=</span> thisPlugin<span class="token punctuation">.</span><span class="token function">findActivityByClassName</span><span class="token punctuation">(</span>toActName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">setPluginIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> plug<span class="token punctuation">,</span> actInThisApk<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="å¯åŠ¨æœ‰å…·ä½“Actionçš„Activity"><a href="#å¯åŠ¨æœ‰å…·ä½“Actionçš„Activity" class="headerlink" title="å¯åŠ¨æœ‰å…·ä½“Actionçš„Activity"></a>å¯åŠ¨æœ‰å…·ä½“Actionçš„Activity</h3></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PlugInfo</span> thisPlugin <span class="token operator">=</span> mgr<span class="token punctuation">.</span><span class="token function">getPluginById</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ActivityInfo</span> actInThisApk <span class="token operator">=</span> thisPlugin<span class="token punctuation">.</span><span class="token function">findActivityByAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">setPluginIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> thisPlugin<span class="token punctuation">,</span> actInThisApk<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="å·å¤©æ¢æ—¥ï¼Œä¿®æ”¹Intent"><a href="#å·å¤©æ¢æ—¥ï¼Œä¿®æ”¹Intent" class="headerlink" title="å·å¤©æ¢æ—¥ï¼Œä¿®æ”¹Intent"></a>å·å¤©æ¢æ—¥ï¼Œä¿®æ”¹Intent</h3></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setPluginIntent</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">PlugInfo</span> plugin<span class="token punctuation">,</span><span class="token class-name">String</span> actName<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">PluginManager</span> mgr <span class="token operator">=</span> <span class="token class-name">PluginManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> pluginId <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ ¹æ®ç±»ååŠ¨æ€ç”Ÿæˆæ–°çš„PluginActivity</span><span class="token function">createProxyDex</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> actName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä¿®æ”¹Intentä¸­çš„ComponentNameï¼Œå°†å…¶æŒ‡å‘androidx.pluginmgr.PluginActivity</span><span class="token class-name">String</span> act <span class="token operator">=</span> mgr<span class="token punctuation">.</span><span class="token function">getFrameworkClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newActivityClassName</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">,</span> actName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ComponentName</span> compname <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>mgr<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> act<span class="token punctuation">)</span><span class="token punctuation">;</span>intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>compname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åŠ¨æ€ç”ŸæˆPluginActivity"><a href="#åŠ¨æ€ç”ŸæˆPluginActivity" class="headerlink" title="åŠ¨æ€ç”ŸæˆPluginActivity"></a>åŠ¨æ€ç”ŸæˆPluginActivity</h2><p>é€šè¿‡<code>createProxyDex()</code>ä¸ºè¦åŠ è½½çš„Activityç”Ÿæˆä»£ç†ç±»</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token class-name">String</span> pkgName <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ActivityClassGenerator</span><span class="token punctuation">.</span><span class="token function">createActivityDex</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> targetClassName<span class="token punctuation">,</span>saveDir<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">getStackTraceString</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…·ä½“ç”Ÿæˆæœºåˆ¶å§”æ‰˜ç»™<code>ActivityClassGenerator</code>å®ç°ï¼Œåé¢å†åˆ†æã€‚</p><h2 id="Activityç”Ÿå‘½å‘¨æœŸå›è°ƒ"><a href="#Activityç”Ÿå‘½å‘¨æœŸå›è°ƒ" class="headerlink" title="Activityç”Ÿå‘½å‘¨æœŸå›è°ƒ"></a>Activityç”Ÿå‘½å‘¨æœŸå›è°ƒ</h2><p><code>PluginActivity</code>çš„ä¸€äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¼šå›è°ƒåˆ°<code>ActivityOverider</code>é‡Œã€‚</p><p>æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªæœ‰<code>overrideAttachBaseContext()</code>ï¼Œ<code>callback_onCreate()</code></p><p>å…ˆçœ‹<code>overrideAttachBaseContext()</code>ã€‚</p><h3 id="overrideAttachBaseContext"><a href="#overrideAttachBaseContext" class="headerlink" title="overrideAttachBaseContext()"></a>overrideAttachBaseContext()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PlugInfo</span> plugin <span class="token operator">=</span> <span class="token class-name">PluginManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPluginById</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span><span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token class-name">PluginManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initPluginApplication</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">getStackTraceString</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token class-name">PluginActivityWrapper</span> actWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginActivityWrapper</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>appWrapper<span class="token punctuation">,</span> plugin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> actWrapper<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span><span class="token function">getAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>overrideAttachBaseContext()</code>æ–¹æ³•æ˜¯ä¸ºäº†æ›´æ”¹Activityä¸­çš„Contextï¼ŒæŠŠé»˜è®¤å®¿ä¸»çš„Contextæ›¿æ¢ä¸ºä¿®æ”¹è¿‡åçš„æ’ä»¶Contextã€‚</p><p>ç”±äºActivityæ˜¯ç»§æ‰¿è‡ª<code>ContextThemeWrapper</code>ï¼Œè€ŒApplicationæ˜¯ç»§æ‰¿<code>ContextWrapper</code>ï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½ç›´æ¥ä½¿ç”¨<code>PluginContextWrapper</code>ï¼Œè€Œæ˜¯æŠŠåœ¨Applicationåˆå§‹åŒ–æ—¶ç”Ÿæˆçš„<code>PluginContextWrapper</code>æ³¨å…¥ç»§æ‰¿è‡ª<code>ContextThemeWrapper</code>çš„<code>PluginActivityWrapper</code>ã€‚</p><p>è¿™æ ·æ’ä»¶Applicationçš„Contextä¸æ’ä»¶Activityçš„Contextä¾¿åœ¨è¡Œä¸ºä¸Šä¸€è‡´äº†ã€‚</p><p>æ¥ç€æ¥çœ‹<code>callback_onCreate()</code>ã€‚</p><h3 id="callback-onCreate"><a href="#callback-onCreate" class="headerlink" title="callback_onCreate()"></a>callback_onCreate()</h3><ul><li><code>callback_onCreate()</code>å…ˆæ›¿æ¢äº†Activityçš„Applicationã€‚</li></ul><p>å› ä¸º<code>PluginActivity</code>å®é™…è¿˜æ˜¯åœ¨å®¿ä¸»ä¸­è°ƒèµ·çš„ï¼Œæ‰€ä»¥é»˜è®¤çš„Contextã€Applicationéƒ½æ˜¯å®¿ä¸»çš„ã€‚æ—¢ç„¶Contextå·²ç»æ›¿æ¢äº†ï¼Œé‚£Applicationä¹Ÿä¸èƒ½æ¼æ‰ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token class-name">Field</span> applicationField <span class="token operator">=</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mApplication"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>applicationField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>applicationField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>fromAct<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span><span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¤„ç†activityçš„ä¸»é¢˜</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// PluginActivityæ˜¯åŠ¨æ€ç”Ÿæˆå¹¶ç»§æ‰¿ä¸åŸæ¥çš„Activityï¼Œæ‰€ä»¥æ­¤å¤„éœ€è¦å–supperClassçš„name</span><span class="token class-name">String</span> actName <span class="token operator">=</span> fromAct<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä»é€šè¿‡PluginManifestUtilè§£æçš„Activity listä¸­æŸ¥æ‰¾å½“å‰Activityçš„ActivityInfo</span><span class="token class-name">ActivityInfo</span> actInfo <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">findActivityByClassName</span><span class="token punctuation">(</span>actName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> resTheme <span class="token operator">=</span> actInfo<span class="token punctuation">.</span><span class="token function">getThemeResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¦‚æœä½¿ç”¨äº†ä¸»é¢˜</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resTheme <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">boolean</span> hasNotSetTheme <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token class-name">Field</span> mTheme <span class="token operator">=</span> <span class="token class-name">ContextThemeWrapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mTheme"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>mTheme<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åˆ¤æ–­PluginActivityçš„mThemeå­—æ®µæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¡¨ç¤ºæ²¡æœ‰è®¾ç½®è¿‡ä¸»é¢˜</span>hasNotSetTheme <span class="token operator">=</span> mTheme<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fromAct<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>hasNotSetTheme<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// æ›¿æ¢PluginActivityçš„mActivityInfo</span><span class="token function">changeActivityInfo</span><span class="token punctuation">(</span>fromAct<span class="token punctuation">)</span><span class="token punctuation">;</span>fromAct<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>resTheme<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä¸ºä½•åœ¨è®¾ç½®äº†ä¸»é¢˜åæ‰æ›¿æ¢mActivityInfoï¼Œæš‚æ—¶è¿˜æ²¡æœ‰çœ‹æ‡‚ã€‚</p><ul><li>æ›¿æ¢PluginActivityçš„mActivityInfo</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">Field</span> field_mActivityInfo<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>field_mActivityInfo <span class="token operator">=</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mActivityInfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>field_mActivityInfo<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">getStackTraceString</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token class-name">PluginManager</span> con <span class="token operator">=</span> <span class="token class-name">PluginManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PlugInfo</span> plugin <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">getPluginByPackageName</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ActivityInfo</span> actInfo <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">findActivityByClassName</span><span class="token punctuation">(</span>actName<span class="token punctuation">)</span><span class="token punctuation">;</span>actInfo<span class="token punctuation">.</span>applicationInfo <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>applicationInfo<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>field_mActivityInfo<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> actInfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">getStackTraceString</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¤„ç†å›è°ƒ</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PluginActivityLifeCycleCallback</span> callback <span class="token operator">=</span> <span class="token class-name">PluginManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPluginActivityLifeCycleCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>callback<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">,</span> fromAct<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ³¨å†Œäº†<code>PluginActivityLifeCycleCallback</code>ï¼Œä¼šåœ¨ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸå†…è§¦å‘å›è°ƒã€‚</p><p>å‰©ä¸‹ä¸€äº›å…¶ä»–çš„ç”Ÿå‘½å‘¨æœŸæ²¡æœ‰åšé¢å¤–çš„å¤„ç†ï¼Œåªæ˜¯å¤„ç†äº†<code>PluginActivityLifeCycleCallback</code>å›è°ƒï¼Œå°±ç•¥è¿‡äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ’ä»¶ </tag>
            
            <tag> PluginActivity </tag>
            
            <tag> ContextWrapper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android PluginManager æºç è§£æ3--PluginManifestUtil</title>
      <link href="/2015/08/11/android-pluginmanager-source-code-analysis-3/"/>
      <url>/2015/08/11/android-pluginmanager-source-code-analysis-3/</url>
      
        <content type="html"><![CDATA[<h2 id="PluginManifestUtilåˆ†æ"><a href="#PluginManifestUtilåˆ†æ" class="headerlink" title="PluginManifestUtilåˆ†æ"></a>PluginManifestUtilåˆ†æ</h2><p><strong>PluginManifestUtil</strong>æ˜¯<strong>Android PluginManager</strong>çš„ä¸€ä¸ªå·¥å…·ç±»ã€‚åªæœ‰ä¸€ä¸ªå…¬å…±æ–¹æ³•<code>setManifestInfo()</code>ï¼Œè´Ÿè´£è§£ææ’ä»¶apkä¸­çš„androidManifest.xmlæ–‡ä»¶ï¼Œå¹¶å°†è§£æçš„ä¿¡æ¯ä¿å­˜åˆ°<code>PluginInfo</code>ä¸­ã€‚</p><ul><li><h3 id="è§£æPackageInfo"><a href="#è§£æPackageInfo" class="headerlink" title="è§£æPackageInfo"></a>è§£æPackageInfo</h3></li></ul><p>é€šè¿‡<code>PackageManager</code>è·å–æ’ä»¶apkæ–‡ä»¶çš„<code>PackageInfo</code>ï¼Œä¿æŒåœ¨<code>PluginInfo</code>ä¸­ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PackageInfo</span> pkgInfo <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageArchiveInfo</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span><span class="token class-name">PackageManager</span><span class="token punctuation">.</span>GET_ACTIVITIES<span class="token operator">|</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span>GET_RECEIVERS<span class="token comment">//</span><span class="token operator">|</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span>GET_PROVIDERS<span class="token comment">//</span><span class="token operator">|</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span>GET_META_DATA<span class="token comment">//</span><span class="token operator">|</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span>GET_SHARED_LIBRARY_FILES<span class="token comment">//</span><span class="token comment">// | PackageManager.GET_SERVICES//</span><span class="token comment">// | PackageManager.GET_SIGNATURES//</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Log.d("ManifestReader: setManifestInfo", "GET_SHARED_LIBRARY_FILES="</span><span class="token comment">// + pkgInfo.applicationInfo.nativeLibraryDir);</span>info<span class="token punctuation">.</span><span class="token function">setPackageInfo</span><span class="token punctuation">(</span>pkgInfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>PackageInfo</code>ä¿å­˜æœ‰æ’ä»¶apkçš„åŒ…åã€ç‰ˆæœ¬ã€æ³¨å†Œçš„activitiesã€servicesã€receiversã€providersã€å£°æ˜çš„æƒé™ç­‰ä¿¡æ¯ã€‚<br>ä½†æ˜¯<strong>Android PluginManager</strong>ç›®å‰åªå¤„ç†äº†activitiesã€receiversã€‚</p><span id="more"></span><ul><li><h3 id="å¤„ç†soæ–‡ä»¶"><a href="#å¤„ç†soæ–‡ä»¶" class="headerlink" title="å¤„ç†soæ–‡ä»¶"></a>å¤„ç†soæ–‡ä»¶</h3></li></ul><p>æŸ¥æ‰¾æ’ä»¶apkä¸­çš„<code>lib</code>ä¸­çš„soæ–‡ä»¶ï¼Œå¹¶è§£å‹åˆ°<code>PluginBaseDir</code>å³<code>PluginManager</code>ä¸­<code>dexInternalStoragePath</code> + <code>pluginId</code>+<code>lib</code>ä¸‹é¢ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">File</span> libdir <span class="token operator">=</span> <span class="token class-name">ActivityOverider</span><span class="token punctuation">.</span><span class="token function">getPluginLibDir</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">extractLibFile</span><span class="token punctuation">(</span>zipFile<span class="token punctuation">,</span> libdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>pkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>nativeLibraryDir<span class="token operator">=</span>libdir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>zipFile<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥æ‰¾è¿‡ç¨‹ä¼šæ ¹æ®è®¾å¤‡cpuæ¶æ„copyç›¸åº”çš„æ–‡ä»¶åˆ°<code>PluginBaseDir</code>ã€‚</p><ul><li><h3 id="è‡ªå®šä¹‰è§£æmanifest-xml"><a href="#è‡ªå®šä¹‰è§£æmanifest-xml" class="headerlink" title="è‡ªå®šä¹‰è§£æmanifest.xml"></a>è‡ªå®šä¹‰è§£æmanifest.xml</h3></li></ul><p>ä½¿ç”¨<code>XmlManifestReader.getManifestXMLFromAPK()</code>è¯»å–æ’ä»¶apkä¸­çš„manifestæ–‡ä»¶ï¼Œç„¶åé€šè¿‡<code>setAttrs()</code>æ–¹æ³•è§£æmanifestæ–‡ä»¶ï¼ŒæŠŠactivityã€recieverã€applicationçš„ä¿¡æ¯ä¿å­˜åœ¨<code>PluginInfo</code>ä¸­ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ZipFile</span> zipFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZipFile</span><span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ZipEntry</span> manifestXmlEntry <span class="token operator">=</span> zipFile<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token class-name">XmlManifestReader</span><span class="token punctuation">.</span>DEFAULT_XML<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> manifestXML <span class="token operator">=</span> <span class="token class-name">XmlManifestReader</span><span class="token punctuation">.</span><span class="token function">getManifestXMLFromAPK</span><span class="token punctuation">(</span>zipFile<span class="token punctuation">,</span>manifestXmlEntry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> manifestXML<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="ç»‘å®šmanifestXmlä¿¡æ¯åˆ°PluginInfo"><a href="#ç»‘å®šmanifestXmlä¿¡æ¯åˆ°PluginInfo" class="headerlink" title="ç»‘å®šmanifestXmlä¿¡æ¯åˆ°PluginInfo"></a>ç»‘å®šmanifestXmlä¿¡æ¯åˆ°PluginInfo</h3></li></ul><p>åˆ†åˆ«è§£æapplicationã€activityã€recieverã€serviceçš„ä¿¡æ¯ï¼Œå¹¶ç»‘å®šåˆ°<code>PluginInfo</code>ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">do</span> <span class="token punctuation">{</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">case</span> <span class="token class-name">XmlPullParser</span><span class="token punctuation">.</span>START_DOCUMENT<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">case</span> <span class="token class-name">XmlPullParser</span><span class="token punctuation">.</span>START_TAG<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token class-name">String</span> tag <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>tag<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"manifest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>namespaceAndroid <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">addActivity</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> namespaceAndroid<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"receiver"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">addReceiver</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> namespaceAndroid<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">addService</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> namespaceAndroid<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"application"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">parseApplicationInfo</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> namespaceAndroid<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">case</span> <span class="token class-name">XmlPullParser</span><span class="token punctuation">.</span>END_TAG<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>eventType <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>eventType <span class="token operator">!=</span> <span class="token class-name">XmlPullParser</span><span class="token punctuation">.</span>END_DOCUMENT<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢å·²activityä¸ºä¾‹åˆ†æã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">ResolveInfo</span> act <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResolveInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>act<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> info<span class="token punctuation">.</span><span class="token function">findActivityByClassNameFromPkg</span><span class="token punctuation">(</span>activityName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token punctuation">{</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">case</span> <span class="token class-name">XmlPullParser</span><span class="token punctuation">.</span>START_TAG<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token class-name">String</span> tag <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"intent-filter"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>act<span class="token punctuation">.</span>filter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>act<span class="token punctuation">.</span>filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"action"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">String</span> actionName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>act<span class="token punctuation">.</span>filter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span>actionName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"category"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">String</span> category <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>act<span class="token punctuation">.</span>filter<span class="token punctuation">.</span><span class="token function">addCategory</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// TODO parse data</span><span class="token punctuation">}</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>eventType <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"activity"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>info<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>act<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¨¡æ‹Ÿç³»ç»Ÿè§£æ<code>ResolveInfo</code>çš„æ–¹å¼ï¼Œä¸ºæ¯ä¸€ä¸ªæ’ä»¶apkä¸­æ³¨å†Œçš„Activityç”Ÿæˆä¸€ä¸ª<code>ResolveInfo</code>ï¼Œä¿å­˜åœ¨<code>PluginInfo</code>ä¸­ï¼Œä¾›ä¹‹åè·å–æŒ‡å®š<code>Intent-Filter</code>çš„Activityã€Serviceç­‰ä½¿ç”¨ã€‚</p><p>ç›®å‰å¯¹äº<code>intent-filter</code>ä¸­çš„<code>data</code>æ ‡ç­¾æ²¡æœ‰å¤„ç†ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="http://developer.android.com/reference/android/content/pm/ResolveInfo.html">ResolveInfo</a></li><li><a href="http://blog.csdn.net/wang_yubin/article/details/8564335">android ResolveInfoè¿ç”¨</a></li><li><a href="http://blog.csdn.net/lo5sea/article/details/38564991">PackageInfoã€ResolveInfo</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ’ä»¶ </tag>
            
            <tag> PackageManager </tag>
            
            <tag> androidManifest </tag>
            
            <tag> PackageInfo </tag>
            
            <tag> ResolveInfo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android PluginManager æºç è§£æ2--FrameworkClassLoader</title>
      <link href="/2015/08/10/android-pluginmanager-source-code-analysis-2/"/>
      <url>/2015/08/10/android-pluginmanager-source-code-analysis-2/</url>
      
        <content type="html"><![CDATA[<p>å­¦ä¹ <strong>Android PluginManager</strong>åŠ è½½æ’ä»¶çš„æœºåˆ¶ï¼Œéœ€è¦å…ˆäº†è§£ç³»ç»Ÿæ˜¯å¦‚ä½•åŠ è½½Activityçš„ã€‚</p><h2 id="Android-å¯åŠ¨Activityçš„æœºåˆ¶"><a href="#Android-å¯åŠ¨Activityçš„æœºåˆ¶" class="headerlink" title="Android å¯åŠ¨Activityçš„æœºåˆ¶"></a>Android å¯åŠ¨Activityçš„æœºåˆ¶</h2><p>Androidç³»ç»Ÿçš„Activityæ˜¯é€šè¿‡ <code>AndroidThread</code>.<code>performLaunchActivity()</code>æ–¹æ³•ç”Ÿæˆå¹¶å¯åŠ¨çš„ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Activity</span> activity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>            cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">incrementExpectedActivityCount</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>    r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        r<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>            <span class="token string">"Unable to instantiate activity "</span> <span class="token operator">+</span> component            <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­<code>r.packageInfo</code>æ˜¯ä¸€ä¸ª<code>LoadedApk</code>å¯¹è±¡ï¼Œä¿å­˜äº†åŠ è½½dexä¸­classæ–‡ä»¶çš„ClassLoaderï¼Œé»˜è®¤æ˜¯ç³»ç»Ÿçš„<code>PathClassLoader</code>ã€‚</p><p>é€šè¿‡<code>AndroidThread</code>æºç ï¼Œçœ‹å‡º<code>AndroidThread</code>é€šè¿‡å§”æ‰˜ç»™<code>Instrumentation</code>çš„<code>newActivity()</code>æ–¹æ³•ç”ŸæˆActivityã€‚</p><span id="more"></span><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Activity</span> <span class="token function">newActivity</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> cl<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span>        <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span>        <span class="token keyword">throws</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span>        <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Activity</span><span class="token punctuation">)</span>cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>newActivity()</code>æ–¹æ³•ä½¿ç”¨æ³¨å…¥çš„ClassLoaderç›´æ¥load Activityçš„ç±»åç”Ÿæˆactivityã€‚</p><p>ç”±äºé»˜è®¤æ˜¯ç³»ç»Ÿçš„<code>PathClassLoader</code>ï¼Œä¸æ”¯æŒä»apkä¸­åŠ è½½ç±»æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ›´æ”¹ClassLoaderæ¥å®ç°åŠ è½½æ’ä»¶apkä¸­çš„ç±»æ–‡ä»¶ã€‚</p><p>ä¹‹å‰<strong>Android PluginManager</strong>åœ¨åˆå§‹åŒ–çš„æ—¶å€™é€šè¿‡åå°„æ›´æ”¹äº†Contextçš„ClassLoader .</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span> mPackageInfo <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span>                    <span class="token string">"mBase.mPackageInfo"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            frameworkClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FrameworkClassLoader</span><span class="token punctuation">(</span>                    ctx<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// set Application's classLoader to FrameworkClassLoader</span>            <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>mPackageInfo<span class="token punctuation">,</span> <span class="token string">"mClassLoader"</span><span class="token punctuation">,</span>                    frameworkClassLoader<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­<code>mBase</code>å°±æ˜¯<code>ContextImpl</code>ï¼Œå…·ä½“åŸå› å‚è§<a href="/2015/08/09/android-pluginmanager-source-code-analysis-1/#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%8F%92%E4%BB%B6%E7%9A%84application">åˆ†æ1</a>ä¸­ContextWapperçš„è§£é‡Šã€‚</p><p><code>r.packageInfo</code>å’Œ<code>ContexImpl</code>çš„<code>mPackageInfo</code>æ˜¯åŒä¸€å¯¹è±¡ã€‚</p><p>è¿™æ ·ä¹‹ååœ¨åŠ è½½Activityç±»æ–‡ä»¶æ—¶å°±ä¼šä½¿ç”¨æ›¿æ¢è¿‡çš„<code>FrameworkClassLoader</code>äº†ã€‚</p><h2 id="FrameworkClassLoader"><a href="#FrameworkClassLoader" class="headerlink" title="FrameworkClassLoader"></a>FrameworkClassLoader</h2><p><code>FrameworkClassLoader</code>èŒè´£æ¯”è¾ƒç®€å•ï¼Œä¸»è¦è´Ÿè´£æ ¹æ®ä¸åŒçš„ç±»åé€‰æ‹©ä¸åŒçš„classLoaderåŠ è½½ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>plugId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">String</span> pluginId <span class="token operator">=</span> plugId<span class="token punctuation">;</span><span class="token class-name">PlugInfo</span> plugin <span class="token operator">=</span> <span class="token class-name">PluginManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPluginById</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>plugin <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">ActivityOverider</span><span class="token punctuation">.</span>targetClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">String</span> actClassName <span class="token operator">=</span> actName<span class="token punctuation">;</span><span class="token keyword">return</span> plugin<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadActivityClass</span><span class="token punctuation">(</span>actClassName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token keyword">return</span> plugin<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> resolv<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæœ‰ä¸‰ç§æƒ…å†µï¼š</p><ul><li><p>åŠ è½½æ’ä»¶ä¸­çš„Activityç±»</p><p>å½“<code>className</code>ä¸º<code>androidx.pluginmgr.PluginActivity</code>æ—¶ï¼Œè¯´æ˜è¦åŠ è½½çš„ç±»æ˜¯ç”±<strong>Android PluginManager</strong>è‡ªåŠ¨ç”Ÿæˆçš„activityä»£ç†ç±»ï¼Œå…·ä½“åŠ è½½å®ç°äº¤ç”±<code>PluginClassLoader.loadActivityClass()</code>å¤„ç†ã€‚</p></li><li><p>åŠ è½½æ’ä»¶ä¸­éActivityç±»</p><p>å½“<code>className</code>ä¸ºæ’ä»¶çš„å…¶å®ƒè‡ªå®šä¹‰ç±»æ—¶ï¼Œé€‰æ‹©<code>PluginClassLoader.loadClass()</code>åŠ è½½ã€‚</p></li><li><p>åŠ è½½å®¿ä¸»ä¸­çš„ç±»</p></li></ul><p>ä¸æ˜¯æ’ä»¶ä¸­çš„ç±»ï¼Œæˆ–è€…æ’ä»¶ä¸­çš„ç±»åŠ è½½å¼‚å¸¸äº†ï¼Œé€‰æ‹©é»˜è®¤çš„ClassLoaderåŠ è½½ç±»ã€‚</p><p>å¼•ç”¨<a href="http://blog.csdn.net/hkxxx/article/details/42194387">ä½œè€…hkxxxå¤§ç¥</a>çš„ä¸¤å¼ å›¾ä½œè¯´æ˜ï¼š</p><p><img src="/img/frameworkclassloader.png" alt="æ’ä»¶å¯åŠ¨æµç¨‹å›¾"></p><p><img src="/img/am_frameworkclassloader_class_diagram.png" alt="framwork classloaderç±»åŠ è½½ç»“æ„"></p><h2 id="PluginClassLoader"><a href="#PluginClassLoader" class="headerlink" title="PluginClassLoader"></a>PluginClassLoader</h2><p><code>PluginClassLoader</code>ç»§æ‰¿è‡ª<code>DexClassLoader</code>ï¼Œä½¿ç”¨<code>FrameworkClassLoader</code>ä½œä¸ºå…¶å§”æ‰˜çš„çˆ¶ClassLoaderã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// pluginManageråˆå§‹åŒ–æ—¶å®ä¾‹åŒ–çš„PluginClassLoader</span><span class="token class-name">PluginClassLoader</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span>               dexOutputPath<span class="token punctuation">,</span> frameworkClassLoader<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// PluginClassLoaderæ„é€ å‡½æ•°</span><span class="token keyword">public</span> <span class="token class-name">PluginClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">String</span> optimizedDir<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">,</span> <span class="token class-name">PlugInfo</span> plugin<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> optimizedDir<span class="token punctuation">,</span>plugin<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>nativeLibraryDir<span class="token punctuation">,</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>thisPlugin <span class="token operator">=</span> plugin<span class="token punctuation">;</span>proxyActivityLoaderMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span><span class="token function">getActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>libraryPath <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>nativeLibraryDir<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>optimizedDirectory <span class="token operator">=</span> optimizedDir<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>PluginClassLoader</code>ç»´æŠ¤ä¸€ä¸ªDexClassLoaderçš„mapï¼Œç¼“å­˜æ’ä»¶æ¯ä¸ªActivityçš„classLoaderã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦ä¸ºæ¯ä¸€ä¸ªActivityéƒ½ç”Ÿæˆä¸€ä¸ªclassloaderå‘¢ï¼Ÿ</p><p>æ¥ç€çœ‹<code>loadActivityClass()</code>æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadActivityClass</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> actClassName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span><span class="token class-name">File</span> dexSavePath <span class="token operator">=</span> <span class="token class-name">ActivityOverider</span><span class="token punctuation">.</span><span class="token function">createProxyDex</span><span class="token punctuation">(</span>thisPlugin<span class="token punctuation">,</span> actClassName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ClassLoader</span> actLoader <span class="token operator">=</span> proxyActivityLoaderMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>actClassName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>actLoader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>actLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>dexSavePath<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span>libraryPath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"PlugActClassLoader("</span><span class="token operator">+</span> actClassName<span class="token operator">+</span><span class="token string">")"</span><span class="token punctuation">,</span> <span class="token string">"loadClass: "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ActivityOverider</span><span class="token punctuation">.</span>targetClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"PlugActClassLoader("</span><span class="token operator">+</span> actClassName<span class="token operator">+</span><span class="token string">")"</span><span class="token punctuation">,</span> <span class="token string">"findClass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> c<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>proxyActivityLoaderMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>actClassName<span class="token punctuation">,</span> actLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> actLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">ActivityOverider</span><span class="token punctuation">.</span>targetClassName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŸæ¥ï¼Œ<code>loadActivityClass()</code>æ–¹æ³•åœ¨åŠ è½½æ’ä»¶çš„Activityä¹‹å‰ï¼Œä¸ºæ¯ä¸ªActivityä½¿ç”¨<strong>dexmaker</strong>åŠ¨æ€ç”Ÿæˆäº†ä¸€ä¸ªä»£ç†çš„<code>PluginActivity</code>ç»§æ‰¿è‡ªåŸActivityï¼Œè¿™æ ·æ’ä»¶ä¸­çš„æ¯ä¸ªActivityéƒ½æœ‰ä¸€ä¸ª<code>PluginActivity.dex</code>æ–‡ä»¶ã€‚</p><p>å¦å¤–ï¼Œç”±äº<a href="http://www.trinea.cn/android/java-loader-common-class/">ClassLoaderéš”ç¦»é—®é¢˜</a>ï¼Œå¿…é¡»æŠŠæ¯ä¸ªclassloaderç¼“å­˜èµ·æ¥ï¼Œä»¥å…ä¸‹æ¬¡é‡æ–°åŠ è½½åŒä¸€ç±»ä¼šæŠ¥ç±»å‹è½¬æ¢å¤±è´¥çš„é”™ã€‚</p><p>è¿™é‡Œnewçš„DexClassLoaderé‡è½½äº†<code>loadClass()</code>æ–¹æ³•ï¼Œå½“è¦åŠ è½½ç±»æ˜¯<code>androidx.pluginmgr.PluginActivity</code>æ—¶ ï¼Œæ›´æ”¹äº†é»˜è®¤çš„æŸ¥æ‰¾æ–¹å¼ï¼Œä¸å†å…ˆä»parent Classloaderä¸­æŸ¥æ‰¾ï¼Œè€Œæ˜¯ç›´æ¥è‡ªå·±æŸ¥æ‰¾ç±»æ–‡ä»¶ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”Ÿæˆ<code>PluginActivity.dex</code>çš„è¿‡ç¨‹ä¸€ç›´å¤„äºä¸»çº¿ç¨‹ï¼Œå…¶ä¸­è¿›è¡Œäº†å¤§é‡çš„æ–‡ä»¶æ“ä½œï¼Œå¯èƒ½ä¼šå¼•èµ·ANRã€‚</p><p>å‰©ä¸‹å°±æ˜¯é‡è½½ClassLoaderçš„<code>loadClass()</code>æ–¹æ³•äº†ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// First, check if the class has already been loaded</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"android.support."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">try</span> <span class="token punctuation">{</span>c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>c <span class="token operator">=</span> <span class="token function">findByParent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>c <span class="token operator">=</span> <span class="token function">findByParent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> c<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œåˆ¤æ–­äº†å¦‚æœç±»åæ˜¯ä»¥<code>android.support.</code>å¼€å¤´ï¼Œè¯´æ˜æ˜¯supportåŒ…é‡Œçš„ç±»ï¼Œä¼˜å…ˆä»å½“å‰çš„classloaderåŠ è½½ï¼Œåœ¨æ’ä»¶ä¸­æ‰¾ä¸åˆ°æ—¶å†ä»å®¿ä¸»ä¸­æŸ¥æ‰¾ï¼Œé¿å…ä¸å®¿ä¸»supportåŒ…å†²çªã€‚</p><p>å¦‚æœç±»åä¸ä»¥<code>android.support.</code>å¼€å¤´ï¼Œåˆ™è¿˜æ˜¯éµå¾ªjavaçš„ClassLoaderçš„åŠ è½½ç±»çš„æ–¹å¼ï¼Œå…ˆå§”æ‰˜ç»™parentæŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°å†ä»è‡ªå·±æŸ¥æ‰¾ã€‚</p><p><code>findByParent()</code>æ–¹æ³•æ˜¯ä¸ºäº†æŸ¥æ‰¾çœŸæ­£å®¿ä¸»çš„ClassLoaderã€‚å…ˆå–å½“å‰ClassLoaderçš„parent ClassLoaderï¼Œå¦‚æœæ˜¯FrameworkClassLoaderçš„è¯ï¼Œç»§ç»­å‘ä¸ŠæŸ¥æ‰¾ï¼Œå³æ˜¯å®¿ä¸»çš„ClassLoaderã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token class-name">ClassLoader</span> parent <span class="token operator">=</span> <span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">FrameworkClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>parent <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>throwEx<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">throw</span> e<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> c<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ’ä»¶ </tag>
            
            <tag> åå°„ </tag>
            
            <tag> ClassLoader </tag>
            
            <tag> DexClassLoader </tag>
            
            <tag> AndroidThread </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android PluginManager æºç è§£æ1--PluginManager</title>
      <link href="/2015/08/08/android-pluginmanager-source-code-analysis-1/"/>
      <url>/2015/08/08/android-pluginmanager-source-code-analysis-1/</url>
      
        <content type="html"><![CDATA[<h2 id="Android-PluginManagerç®€ä»‹"><a href="#Android-PluginManagerç®€ä»‹" class="headerlink" title="Android PluginManagerç®€ä»‹"></a>Android PluginManagerç®€ä»‹</h2><p><strong>Android pluginManager</strong>æ˜¯<a href="https://github.com/houkx/">HouKangxi</a>å¤§ç¥å¼€å‘çš„ä¸€ä¸ªandroidæ’ä»¶åŒ–å¼€å‘æ¡†æ¶ï¼Œå¯ä»¥åŠ¨æ€çš„åŠ è½½apkï¼Œå®ç°ç»„ä»¶çš„çƒ­æ’æ‹”ã€‚</p><p>é¡¹ç›®åœ°å€ï¼š<a href="">https://github.com/houkx/android-pluginmgr</a></p><p>ç›¸æ¯”äºå…¶ä»–çš„æ’ä»¶åŒ–è§£å†³æ–¹æ¡ˆï¼Œ<strong>Android pluginManager</strong>ä¸»è¦ä¼˜åŠ¿æ˜¯é‡‡ç”¨äº†åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œè‡ªåŠ¨ä¸ºæ’ä»¶ç”Ÿæˆä»£ç†activityï¼Œæ’ä»¶apkåŸºæœ¬æ— éœ€åšä»»ä½•æ›´æ”¹ã€‚</p><h3 id="å®ç°çš„åŠŸèƒ½ç‚¹ï¼š"><a href="#å®ç°çš„åŠŸèƒ½ç‚¹ï¼š" class="headerlink" title="å®ç°çš„åŠŸèƒ½ç‚¹ï¼š"></a>å®ç°çš„åŠŸèƒ½ç‚¹ï¼š</h3><ul><li>æ’ä»¶ä¸ºæ™®é€šapkï¼Œæ— é¡»ä¾èµ–ä»»ä½•jar(æ‘˜è‡ª<a href="http://blog.csdn.net/hkxxx/article/details/42194387">ä½œè€…çš„åšå®¢</a>)</li><li>Activityç”Ÿå‘½å‘¨æœŸç”±ç³»ç»Ÿè‡ªå·±ç®¡ç†</li><li>ä½¿ç”¨ç®€å•ï¼Œåªéœ€è¦äº†è§£ä¸€ä¸ªç±»PluginManagerçš„ä¸¤ä¸ªæ–¹æ³•</li><li>å¯åŠ¨Activityçš„æ•ˆç‡é«˜</li><li>ä¸ä¿®æ”¹æ’ä»¶ï¼Œè¢«åŠ è½½çš„æ’ä»¶ä»ç„¶å¯ä»¥ç‹¬ç«‹å®‰è£…ã€‚</li><li>å¯åŠ è½½ä»»æ„apkä¸­çš„ Activity (åŒ…æ‹¬å­ç±» ActionBarActivity ã€FragmentActivity)çš„æ´¾ç”Ÿç±»(ä¸åŒ…æ‹¬è¿åé™åˆ¶æ¡ä»¶çš„Activity)</li><li>æ”¯æŒæ’ä»¶è‡ªå®šä¹‰Application</li><li>æ”¯æŒæ’ä»¶Apkä¸­çš„Activityè·³è½¬åˆ°åˆ«çš„Activity(æ’ä»¶å†…éƒ¨çš„æˆ–ç³»ç»Ÿçš„,å¤–éƒ¨å·²å®‰è£…apkçš„ï¼Œç”šè‡³æ˜¯åˆ«çš„æ’ä»¶ä¸­çš„),ä¹Ÿæ²¡æœ‰ä»»ä½•é™åˆ¶</li><li>æ”¯æŒActivityè®¾ç½®ä¸»é¢˜(ä¸ç³»ç»Ÿçš„ä¸»é¢˜åº”ç”¨è§„åˆ™ä¸€æ ·ï¼Œå¦‚æœActivityæ²¡æŒ‡å®šTheme,ä½†æ‰€åœ¨ApplicationæŒ‡å®šäº†Themeï¼Œåˆ™ä½¿ç”¨Applicationçš„Theme)</li><li>åˆæ­¥æ”¯æŒ.so</li><li>æ”¯æŒæ’ä»¶ä½¿ç”¨ SharedPreference æˆ– SQLiteæ•°æ®åº“(å°šæœªå®Œå–„)</li></ul><span id="more"></span><h3 id="å°šæœªå®Œæˆçš„éƒ¨åˆ†ï¼š"><a href="#å°šæœªå®Œæˆçš„éƒ¨åˆ†ï¼š" class="headerlink" title="å°šæœªå®Œæˆçš„éƒ¨åˆ†ï¼š"></a>å°šæœªå®Œæˆçš„éƒ¨åˆ†ï¼š</h3><ul><li>ç›®å‰è¿˜ä¸æ”¯æŒserviceã€content provider</li></ul><h3 id="ä¸€äº›é™åˆ¶ï¼š"><a href="#ä¸€äº›é™åˆ¶ï¼š" class="headerlink" title="ä¸€äº›é™åˆ¶ï¼š"></a>ä¸€äº›é™åˆ¶ï¼š</h3><ul><li>æ’ä»¶ä¸­çš„æƒé™ï¼Œæ— æ³•åŠ¨æ€æ³¨å†Œï¼Œæ’ä»¶ä¸­çš„æƒé™éƒ½å¾—åœ¨å®¿ä¸»ä¸­æ³¨å†Œ</li><li>ä¸æ”¯æŒå¤šè¿›ç¨‹</li><li>Manifestä¸­æ³¨å†Œçš„activityçš„ç›®å‰åªèƒ½ä½¿ç”¨ä¸€ç§launchModeï¼Œ<br>è¦æ”¯æŒsingleTaskç­‰å¤šç§launchModeï¼Œéœ€è¦è‡ªå·±ç»´æŠ¤activityæ ˆæ¥æ¨¡æ‹Ÿã€‚</li></ul><h3 id="åŠ¨æ€åŠ è½½apkçš„æ€è·¯ï¼š"><a href="#åŠ¨æ€åŠ è½½apkçš„æ€è·¯ï¼š" class="headerlink" title="åŠ¨æ€åŠ è½½apkçš„æ€è·¯ï¼š"></a>åŠ¨æ€åŠ è½½apkçš„æ€è·¯ï¼š</h3><p>å°±ç›®å‰è‡ªå·±äº†è§£çš„æƒ…å†µæ¥çœ‹ï¼ŒåŠ¨æ€åŠ è½½apkï¼Œä¸€èˆ¬æ˜¯é€šè¿‡DexClassLoaderï¼ŒåŠ è½½apkä¸­çš„Activityã€‚</p><p>æ­¤æ—¶è°ƒèµ·çš„Activityæ˜¯æ™®é€šçš„Javaå¯¹è±¡ï¼Œæ²¡æœ‰äº†onCreate() ã€onStart ()ã€onResume()ã€onPause()ã€onStop()ã€onDestory()ç­‰ç”Ÿå‘½å‘¨æœŸã€‚</p><p>ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬éƒ½ä¼šåœ¨å®¿ä¸»ä¸­æœ‰ä¸€ä¸ªProxyActivityï¼Œå®ƒæ˜¯ä¸€ä¸ªçœŸå®çš„Activityï¼Œç”±ç³»ç»Ÿç®¡ç†å®ƒçš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>ProxyActivityæŒæœ‰ä¸€ä¸ªæ’ä»¶çš„Activityçš„å¼•ç”¨ï¼Œå½“ç³»ç»Ÿè§¦å‘ProxyActivityçš„ç”Ÿå‘½å‘¨æœŸæ—¶ï¼ŒProxyActivityé€šçŸ¥æ’ä»¶çš„Activityæ¥æ¨¡æ‹Ÿæ­£å¸¸Activityçš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>ProxyActivityé€šçŸ¥æ’ä»¶çš„Activityæ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>ç›´æ¥é€šè¿‡åå°„è°ƒç”¨æ’ä»¶Activityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚æ•ˆç‡è¾ƒä½</li><li>æ’ä»¶Activityç»§æ‰¿ä¸€ä¸ªBasePluginActivityæˆ–è€…å®ç°ä¸€ä¸ªPluginInterfaceã€‚å¯¹æ’ä»¶æµ¸å…¥æ€§è¾ƒå¤§ï¼Œéœ€è¦æ”¹åŠ¨è¾ƒå¤šä»£ç ã€‚</li></ul><p>å…¶ä¸­ä¸€ä¸ªéš¾ç‚¹æ˜¯æ’ä»¶èµ„æºæ–‡ä»¶çš„è®¿é—®ã€‚</p><p>ç”±äºActivityå˜æˆäº†æ™®é€šçš„Javaå¯¹è±¡ï¼Œæ²¡æœ‰äº†Contextï¼Œä¸èƒ½é€šè¿‡getResources()ç›´æ¥è®¿é—®æ’ä»¶ä¸­çš„èµ„æºã€‚<br>è§£å†³æ–¹æ¡ˆæœ‰å‡ ç§ï¼š</p><ul><li>æŠŠæ’ä»¶çš„èµ„æºå¤åˆ¶åˆ°å®¿ä¸»ä¸­ï¼Œå‘æ’ä»¶æ³¨å…¥å®¿ä¸»çš„Context</li><li>æŠŠæ’ä»¶çš„èµ„æºè§£å‹åˆ°sdå¡æŸè·¯å¾„ä¸‹ï¼Œä»¥æµçš„å½¢å¼è¯»å–ï¼Œè‡ªå·±è§£æ</li><li>ä¿®æ”¹AssetManagerï¼ŒæŠŠæ’ä»¶çš„è·¯å¾„æ·»åŠ åˆ°AssetManagerä¸­</li></ul><h2 id="PluginManageråˆå§‹åŒ–"><a href="#PluginManageråˆå§‹åŒ–" class="headerlink" title="PluginManageråˆå§‹åŒ–"></a>PluginManageråˆå§‹åŒ–</h2><ul><li><h3 id="è·å–application-Context"><a href="#è·å–application-Context" class="headerlink" title="è·å–application Context"></a>è·å–application Context</h3></li></ul><p>PluginManageræ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œåœ¨åˆå§‹åŒ–æ—¶å°†å®¿ä¸»ï¼ˆhostï¼‰application Context ä½œä¸ºPluginManagerçš„Context</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Context</span> ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">PluginManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    instance<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="åˆ›å»ºpluginsç›®å½•"><a href="#åˆ›å»ºpluginsç›®å½•" class="headerlink" title="åˆ›å»ºpluginsç›®å½•"></a>åˆ›å»ºpluginsç›®å½•</h3></li></ul><p>åœ¨<code>dexInternalStoragePath</code>ç›®å½•ä¸‹ä¿å­˜æ’ä»¶çš„åŸapkæ–‡ä»¶ï¼ŒåŠåŠ¨æ€ç”Ÿæˆçš„æ–°çš„dexæ–‡ä»¶</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">dexInternalStoragePath <span class="token operator">=</span> context        <span class="token punctuation">.</span><span class="token function">getDir</span><span class="token punctuation">(</span><span class="token string">"plugins"</span><span class="token punctuation">,</span> <span class="token class-name">Context</span><span class="token punctuation">.</span>MODE_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>dexInternalStoragePath<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="åˆ›å»ºpluginoutsç›®å½•"><a href="#åˆ›å»ºpluginoutsç›®å½•" class="headerlink" title="åˆ›å»ºpluginoutsç›®å½•"></a>åˆ›å»ºpluginoutsç›®å½•</h3></li></ul><p>åœ¨<code>dexOutputPath</code>ç›®å½•ä¸‹ä¿å­˜æ’ä»¶çš„åŸdexæ–‡ä»¶</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">File</span> optimizedDexPath <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getDir</span><span class="token punctuation">(</span><span class="token string">"plugsout"</span><span class="token punctuation">,</span> <span class="token class-name">Context</span><span class="token punctuation">.</span>MODE_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>optimizedDexPath<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    optimizedDexPath<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>dexOutputPath <span class="token operator">=</span> optimizedDexPath<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="æ›¿æ¢classLoader"><a href="#æ›¿æ¢classLoader" class="headerlink" title="æ›¿æ¢classLoader"></a>æ›¿æ¢classLoader</h3></li></ul><p>æŠŠå®¿ä¸» application context çš„<code>classLoader</code>é€šè¿‡åå°„æ›¿æ¢ä¸ºè‡ªå®šä¹‰çš„classLoader FrameworkClassLoader.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>          <span class="token class-name">Object</span> mPackageInfo <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span>                  <span class="token string">"mBase.mPackageInfo"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          frameworkClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FrameworkClassLoader</span><span class="token punctuation">(</span>                  ctx<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// set Application's classLoader to FrameworkClassLoader</span>          <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>mPackageInfo<span class="token punctuation">,</span> <span class="token string">"mClassLoader"</span><span class="token punctuation">,</span>                  frameworkClassLoader<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åŠ è½½æ’ä»¶"><a href="#åŠ è½½æ’ä»¶" class="headerlink" title="åŠ è½½æ’ä»¶"></a>åŠ è½½æ’ä»¶</h2><ul><li><h3 id="ç”ŸæˆPluginInfo-å¯¹è±¡ä¿å­˜æ’ä»¶ä¿¡æ¯"><a href="#ç”ŸæˆPluginInfo-å¯¹è±¡ä¿å­˜æ’ä»¶ä¿¡æ¯" class="headerlink" title="ç”ŸæˆPluginInfo å¯¹è±¡ä¿å­˜æ’ä»¶ä¿¡æ¯"></a>ç”ŸæˆPluginInfo å¯¹è±¡ä¿å­˜æ’ä»¶ä¿¡æ¯</h3></li></ul><p>æŠŠç”Ÿæˆçš„PluginInfoå¯¹è±¡ä¿å­˜Mapä¸­ç¼“å­˜ï¼Œè®°å½•å½“å‰åŠ è½½çš„æ’ä»¶ã€‚è¿™é‡Œä¿å­˜PluginInfoæ—¶éœ€è¦åœ¨è°ƒç”¨æ’ä»¶çš„åœ°æ–¹ä¸ºæ’ä»¶ä¼ å…¥ä¸€ä¸ªidï¼Œå¦‚æœidä¸ºnullï¼Œåˆ™é»˜è®¤ä½¿ç”¨æ’ä»¶çš„åŒ…å‘½ä½œä¸ºæ’ä»¶idã€‚</p><p>ä¼šåŒæ—¶ä¿æŒåœ¨<code>pluginIdToInfoMap</code>ï¼Œ<code>pluginPkgToInfoMap</code> ä¸¤ä¸ªmapä¸­ï¼Œæ­¤å¤„æœ‰å†—ä½™çš„å«Œç–‘ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PlugInfo</span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PlugInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>info<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>pluginId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> pluginApk<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> pluginId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>pluginPkgToInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>plugInfo<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plugInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>pluginIdToInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>plugInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plugInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="copyæ’ä»¶apkæ–‡ä»¶åˆ°dexInternalStoragePathç›®å½•ä¸‹"><a href="#copyæ’ä»¶apkæ–‡ä»¶åˆ°dexInternalStoragePathç›®å½•ä¸‹" class="headerlink" title="copyæ’ä»¶apkæ–‡ä»¶åˆ°dexInternalStoragePathç›®å½•ä¸‹"></a>copyæ’ä»¶apkæ–‡ä»¶åˆ°<code>dexInternalStoragePath</code>ç›®å½•ä¸‹</h3></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">File</span> privateFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>dexInternalStoragePath<span class="token punctuation">,</span>        targetFileName <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> pluginApk<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> targetFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>info<span class="token punctuation">.</span><span class="token function">setFilePath</span><span class="token punctuation">(</span>privateFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pluginApk<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>privateFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">copyApkToPrivatePath</span><span class="token punctuation">(</span>pluginApk<span class="token punctuation">,</span> privateFile<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="è§£ææ’ä»¶manifest-xmlä¸­çš„ä¿¡æ¯"><a href="#è§£ææ’ä»¶manifest-xmlä¸­çš„ä¿¡æ¯" class="headerlink" title="è§£ææ’ä»¶manifest.xmlä¸­çš„ä¿¡æ¯"></a>è§£ææ’ä»¶manifest.xmlä¸­çš„ä¿¡æ¯</h3></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> dexPath <span class="token operator">=</span> privateFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PluginManifestUtil</span><span class="token punctuation">.</span><span class="token function">setManifestInfo</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dexPath<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p> å¤„ç†è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¹‹åå†åˆ†æ</p><ul><li><h3 id="ç”Ÿæˆè‡ªå®šä¹‰ClassLoaderå¤‡ç”¨"><a href="#ç”Ÿæˆè‡ªå®šä¹‰ClassLoaderå¤‡ç”¨" class="headerlink" title="ç”Ÿæˆè‡ªå®šä¹‰ClassLoaderå¤‡ç”¨"></a>ç”Ÿæˆè‡ªå®šä¹‰ClassLoaderå¤‡ç”¨</h3></li></ul><p><code>PluginClassLoader</code>ç»§æ‰¿è‡ª<code>DexClassLoader</code>ï¼Œä»¥<code>FramworkClassLoader</code>ä½œä¸ºparent ClassLoaderï¼ŒæŠŠç”Ÿæˆçš„<code>pluginClassLoader</code>ä¿å­˜åœ¨<code>pluginInfo</code>ä¸­</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PluginClassLoader</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> dexOutputPath<span class="token punctuation">,</span> frameworkClassLoader<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>info<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è‡ªå®šä¹‰çš„<code>PluginClassLoader</code>ä¼šåœ¨ä¹‹åçš„<code>FrameworkClassLoader</code> <code>loadClass</code>æ—¶ç”¨åˆ°ã€‚</p><p><code>FrameworkClassLoader</code>çš„<code>loadClass</code>æ–¹æ³•æ˜¯Android PluginManagerçš„æ ¸å¿ƒæ–¹æ³•ï¼Œæ ¹æ®éœ€è¦é€‰æ‹©ä¸åŒçš„classLoaderæ¥åŠ è½½ç±»æ–‡ä»¶ã€‚å½“éœ€è¦åŠ è½½æ’ä»¶ä¸­çš„ç±»æ—¶ï¼Œä¾¿å§”æ‰˜ç»™<code>PluginClassLoader</code>ã€‚</p><p><code>PluginClassLoader</code>ç”±äºç»§æ‰¿è‡ª<code>DexClassLoader</code> ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åŠ è½½apkä¸­çš„ç±»æ–‡ä»¶ï¼Œä»è€Œå®ç°æ’ä»¶åŒ–çš„èƒ½åŠ›ã€‚</p><ul><li><h3 id="ä¿®æ”¹AssetManageråŠ è½½èµ„æºçš„ä½ç½®"><a href="#ä¿®æ”¹AssetManageråŠ è½½èµ„æºçš„ä½ç½®" class="headerlink" title="ä¿®æ”¹AssetManageråŠ è½½èµ„æºçš„ä½ç½®"></a>ä¿®æ”¹AssetManageråŠ è½½èµ„æºçš„ä½ç½®</h3></li></ul><p>ç°åœ¨å·²ç»èƒ½åŠ è½½apkä¸­çš„ç±»æ–‡ä»¶äº†ï¼Œä½†æ˜¯è¿˜ä¸èƒ½ç›´æ¥è®¿é—®apkä¸­çš„èµ„æºæ–‡ä»¶ã€‚</p><p>å¹³å¸¸é€šè¿‡<code>Context.getString()</code>ã€<code>Context.getDrawable()</code>è®¿é—®resä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå…¶å®æ˜¯å§”æ‰˜ç»™<code>Resources</code>å¤„ç†çš„ï¼Œæ‰€ä»¥è¦ä½¿æ’ä»¶èƒ½æ­£ç¡®è¯»å–èµ„æºæ–‡ä»¶ï¼Œéœ€è¦ä»<code>Resources</code>å…¥æ‰‹ã€‚</p><p>ç»§ç»­åˆ†æ<code>Resources</code>ï¼Œå‘ç°<code>Resources.getString()</code>ã€<code>Resources.getDrawable()</code>ç­‰åˆæ˜¯å§”æ‰˜ç»™<code>AssetManager</code>çš„<code>getResourceValue()</code>æ–¹æ³•è¯»å–resä¸‹çš„èµ„æºã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Drawable</span> <span class="token function">getDrawable</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Theme</span> theme<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">{</span>    <span class="token class-name">TypedValue</span> value<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment">// é€šè¿‡getValueä»resä¸­è¯»å–æ•°æ®</span>    <span class="token function">getValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// æŠŠtypedValueä¸­çš„æ•°æ®è½¬ä¸ºDrawable</span>    <span class="token keyword">final</span> <span class="token class-name">Drawable</span> res <span class="token operator">=</span> <span class="token function">loadDrawable</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> id<span class="token punctuation">,</span> theme<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">TypedValue</span> outValue<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolveRefs<span class="token punctuation">)</span>        <span class="token keyword">throws</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment">// å§”æ‰˜ç»™assetManagerè¯»å–èµ„æºï¼ŒæŠŠèµ„æºå…ƒæ•°æ®ä¿å­˜åœ¨typedValueä¸­</span>    mAssets<span class="token punctuation">.</span><span class="token function">getResourceValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> outValue<span class="token punctuation">,</span> resolveRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¹¶ä¸”<code>Resources</code>å¯¹è±¡æ˜¯<code>ResourcesManager.getTopLevelResources()</code>é€šè¿‡<code>AssertManager</code>ç”Ÿæˆçš„ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">              <span class="token keyword">public</span> <span class="token class-name">Resources</span> <span class="token function">getTopLevelResources</span><span class="token punctuation">(</span><span class="token class-name">String</span> resDir<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> splitResDirs<span class="token punctuation">,</span>           <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> overlayDirs<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> libDirs<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span>           <span class="token class-name">Configuration</span> overrideConfiguration<span class="token punctuation">,</span> <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token class-name">AssetManager</span> assets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>resDir <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>assets<span class="token punctuation">.</span><span class="token function">addAssetPath</span><span class="token punctuation">(</span>resDir<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span>       <span class="token punctuation">}</span>              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>       r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> dm<span class="token punctuation">,</span> config<span class="token punctuation">,</span> compatInfo<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>              <span class="token keyword">return</span> r<span class="token punctuation">;</span>ï½<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥çœ‹èµ·æ¥åªè¦æå®šäº†<code>AssetManager</code>ï¼Œå°±èƒ½é¡ºåˆ©ä½¿æ’ä»¶è®¿é—®åˆ°æ­£ç¡®çš„èµ„æºæ–‡ä»¶äº†ã€‚</p><p>ç»§ç»­åˆ†æ<code>AssetManager</code>ï¼Œå¹¸è¿çš„æ˜¯<code>AssetManager</code>æä¾›äº†ä¸€ä¸ª<code>addAssetPath()</code>æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥è¯»å–zipæ–‡ä»¶ä¸­çš„èµ„æºã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Add an additional set of assets to the asset manager.  This can be * either a directory or ZIP file.  Not for use by applications.  Returns * the cookie of the added asset, or 0 on failure. * {@hide} */</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">addAssetPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">addAssetPathNative</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">makeStringBlocks</span><span class="token punctuation">(</span>mStringBlocks<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥æˆ‘ä»¬æŠŠæ’ä»¶apkçš„è·¯å¾„æ·»åŠ åˆ°assetpathä¸­ï¼Œä¹‹åç”Ÿæˆçš„ä»£ç†activityå°±èƒ½è®¿é—®åˆ°æ’ä»¶ä¸­çš„èµ„æºæ–‡ä»¶ã€‚</p><p>æˆ‘ä»¬éœ€è¦ç”Ÿæˆä¸€ä¸ª<code>AssetManager</code>ï¼Œå¹¶æŠŠæ’ä»¶apkçš„è·¯å¾„æ·»åŠ è¿›<code>AssetManager</code>ä¸­ã€‚</p><p><code>AssetManager</code>å¹¶ä¸èƒ½ç›´æ¥newå‡ºæ¥ï¼Œ<code>addAssetPath()</code>æ–¹æ³•ä¹Ÿä¸èƒ½ç›´æ¥æ–¹æ³•ï¼Œä½†æ˜¯éƒ½å¯ä»¥åŒåå°„è§£å†³ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token class-name">AssetManager</span> am <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AssetManager</span><span class="token punctuation">)</span> <span class="token class-name">AssetManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    am<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"addAssetPath"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>am<span class="token punctuation">,</span> dexPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    info<span class="token punctuation">.</span><span class="token function">setAssetManager</span><span class="token punctuation">(</span>am<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Resources</span> ctxres <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Resources</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span>am<span class="token punctuation">,</span> ctxres<span class="token punctuation">.</span><span class="token function">getDisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            ctxres<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    info<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ ·ä¾¿å¯ä»¥è®¿é—®æ’ä»¶ä¸­çš„èµ„æºäº†ã€‚</p><ul><li><h3 id="åˆå§‹åŒ–æ’ä»¶çš„application"><a href="#åˆå§‹åŒ–æ’ä»¶çš„application" class="headerlink" title="åˆå§‹åŒ–æ’ä»¶çš„application"></a>åˆå§‹åŒ–æ’ä»¶çš„application</h3></li></ul><p>åŒæ ·æ˜¯é€šè¿‡åå°„ï¼Œç”¨ä¹‹å‰é€šè¿‡</p><pre class="line-numbers language-none"><code class="language-none">PluginManifestUtil.setManifestInfo(context, dexPath, info); <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ–¹æ³•è·å–ä¿å­˜åœ¨<code>PlugInfo</code>é‡Œçš„æ’ä»¶Applicationç±»åï¼Œå®ä¾‹åŒ–æ’ä»¶çš„applicationã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ClassLoader</span> loader <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> applicationClass <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Application</span> application <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">)</span> applicationClass            <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setApplicationBase</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> application<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// invoke plugin application's onCreate()</span>    application<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">getStackTraceString</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ä¾‹åŒ–æ’ä»¶çš„Applicationåï¼Œå¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œ æ­¤æ—¶çš„Application Contextè¿˜æ˜¯å®¿ä¸»ï¼ˆHostï¼‰çš„Contextï¼Œç›´æ¥<code>getResources()</code>ï¼Œ<code>getFilesDir()</code>ç­‰è·å–åˆ°çš„è¿˜æ˜¯å®¿ä¸»çš„ã€‚</p><p>éœ€è¦ç”¨<code>PluginContextWrapper</code>æ›¿æ¢æ‰æ’ä»¶Applicationä¸­Contextã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PluginContextWrapper</span> ctxWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginContextWrapper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>         plugin<span class="token punctuation">)</span><span class="token punctuation">;</span> plugin<span class="token punctuation">.</span>appWrapper <span class="token operator">=</span> ctxWrapper<span class="token punctuation">;</span> <span class="token comment">// attach</span> <span class="token class-name">Method</span> attachMethod <span class="token operator">=</span> <span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>         <span class="token string">"attach"</span><span class="token punctuation">,</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> attachMethod<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> attachMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> ctxWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">Application</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Build</span><span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"registerComponentCallbacks"</span><span class="token punctuation">,</span>                 <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.content.ComponentCallbacks"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> application<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ContextWrapperçš„åŸç†å’Œæœºåˆ¶å‚è€ƒæœ¬æ–‡åçš„å‚è€ƒæ–‡ç« <a href="#%E5%8F%82%E8%80%83">[5]</a><a href="#%E5%8F%82%E8%80%83">[6]</a><a href="#%E5%8F%82%E8%80%83">[7]</a><a href="#%E5%8F%82%E8%80%83">[8]</a></p><ul><li><h3 id="åŠ è½½ç›®å½•ä¸‹æ‰€æœ‰æ’ä»¶"><a href="#åŠ è½½ç›®å½•ä¸‹æ‰€æœ‰æ’ä»¶" class="headerlink" title="åŠ è½½ç›®å½•ä¸‹æ‰€æœ‰æ’ä»¶"></a>åŠ è½½ç›®å½•ä¸‹æ‰€æœ‰æ’ä»¶</h3></li></ul><p>åŒåŠ è½½å•ä¸ªæ’ä»¶çš„æ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯éå†ç›®å½•ä¸‹çš„æ‰€æœ‰apkæ–‡ä»¶ã€‚</p><h2 id="å¯åŠ¨æ’ä»¶ä¸­çš„MainActivity"><a href="#å¯åŠ¨æ’ä»¶ä¸­çš„MainActivity" class="headerlink" title="å¯åŠ¨æ’ä»¶ä¸­çš„MainActivity"></a>å¯åŠ¨æ’ä»¶ä¸­çš„MainActivity</h2><p><code>startMainActivity()</code>ä¸­çš„äº‹æƒ…æ¯”è¾ƒç®€å•ï¼Œæ ¹æ®æ’ä»¶idæˆ–æ’ä»¶åŒ…ååœ¨ä¹‹å‰ç¼“å­˜çš„Mapä¸­æŸ¥æ‰¾<code>PlugInfo</code>ï¼Œé€šè¿‡<code>framwworkClassLoader</code>çš„<code>newActivityClassName()</code>æ–¹æ³•ç¼“å­˜è¦å¯åŠ¨çš„æ’ä»¶idåŠActivityç±»åï¼Œä¾›<code>framwworkClassLoader</code>åœ¨loadClassæ—¶ä½¿ç”¨ã€‚</p><p>è€Œ<code>newActivityClassName()</code>æ–¹æ³•æœ¬èº«åªæ˜¯è¿”å›ä¸€ä¸ªåä¸º<code>androidx.pluginmgr.PluginActivity</code>çš„ä»£ç†Activityç±»åã€‚</p><p>è‡³äºå…·ä½“å¦‚ä½•é€šè¿‡<code>androidx.pluginmgr.PluginActivity</code>åŠ è½½åˆ°çœŸæ­£æ’ä»¶ä¸­çš„Activityï¼Œåˆ™æ˜¯åœ¨<code>PluginClassLoader</code>ä¸­çš„<code>loadActivityClass</code>æ–¹æ³•å®ç°çš„ï¼Œåé¢å†å…·ä½“åˆ†æã€‚</p><h2 id="å…¶ä»–æ–¹æ³•"><a href="#å…¶ä»–æ–¹æ³•" class="headerlink" title="å…¶ä»–æ–¹æ³•"></a>å…¶ä»–æ–¹æ³•</h2><p>å‰©ä¸‹ä¸€äº›åˆ é™¤æ’ä»¶ã€å¸è½½æ’ä»¶çš„æ–¹æ³•ï¼Œä»¥åŠä¸€äº›æ–¹æ³•çš„é‡è½½ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚</p><p>æœ¬æ–‡æ˜¯åœ¨å­¦ä¹ Android pluginManagerä¹‹ä½™å°†åšä¸€äº›ç¬”è®°å¤‡å¿˜ï¼Œåˆšå¼€å§‹ç ”ç©¶æ’ä»¶ï¼Œå¯¹å…¶ä¸­éš¾å…æœ‰ç†è§£ä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€æŒ‡æ­£ï¼Œå…±åŒå­¦ä¹ ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="http://www.trinea.cn/android/java-loader-common-class/">Java ClassLoaderåŸºç¡€åŠåŠ è½½ä¸åŒä¾èµ– Jar ä¸­çš„å…¬å…±ç±»</a></li><li><a href="http://www.trinea.cn/android/android-plugin/">Android æ’ä»¶åŒ– åŠ¨æ€å‡çº§</a></li><li><a href="http://blog.csdn.net/singwhatiwanna/article/details/39937639">APKåŠ¨æ€åŠ è½½æ¡†æ¶ï¼ˆDLï¼‰è§£æ</a></li><li><a href="http://codekk.com/open-source-project-analysis/detail/Android/FFish/DynamicLoadApk%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">DynamicLoadApk æºç è§£æ</a></li><li><a href="http://blog.csdn.net/canghai1129/article/details/41577901">Androidä¸è®¾è®¡æ¨¡å¼â€”â€”è£…é¥°è€…(Decorator)æ¨¡å¼</a></li><li><a href="http://blog.csdn.net/z1074971432/article/details/12561369">æ·±å…¥ç†è§£ Context</a></li><li><a href="http://blog.csdn.net/qinjuning/article/details/7310620">Androidä¸­Contextè¯¦è§£ â€”- ä½ æ‰€ä¸çŸ¥é“çš„Context</a></li><li><a href="http://blogs.360.cn/blog/proxydelegate-application/">Androidçš„Proxy/Delegate Applicationæ¡†æ¶</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ’ä»¶ </tag>
            
            <tag> åå°„ </tag>
            
            <tag> ClassLoader </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å›¾è§£javascriptä¸­çš„å˜é‡å¯¹è±¡ã€é—­åŒ…ã€ä½œç”¨åŸŸé“¾æœºç†</title>
      <link href="/2014/11/01/javascript-vo-closure-scopechain/"/>
      <url>/2014/11/01/javascript-vo-closure-scopechain/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯é—­åŒ…"><a href="#ä»€ä¹ˆæ˜¯é—­åŒ…" class="headerlink" title="ä»€ä¹ˆæ˜¯é—­åŒ…"></a>ä»€ä¹ˆæ˜¯é—­åŒ…</h2><p><strong>javascript</strong>ä¸­çš„<strong>é—­åŒ…</strong>æ˜¯ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„æ­¦å™¨ï¼Œææ¸…<strong>é—­åŒ…</strong>ï¼Œ<strong>ä½œç”¨åŸŸé“¾</strong>çš„ä½œç”¨æœºç†ï¼Œèƒ½è®©æˆ‘æ›´å¥½çš„å°†<strong>é—­åŒ…</strong>è¿ç”¨åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ã€‚</p><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Closures">mozillaå¼€å‘è€…ä¸­å¿ƒçš„å®šä¹‰ï¼š</a></p><blockquote><p>Closures are functions that refer to independent (free) variables. </p></blockquote><blockquote><p>In other words, the function defined in the closure â€˜remembersâ€™ the environment in which it was created. </p></blockquote><p>æˆ‘ç†è§£çš„<strong>é—­åŒ…</strong>æ˜¯ä¸€ä¸ª<strong>function</strong>ï¼Œå¹¶ä¸”å…·æœ‰è®¿é—®ä¸åœ¨<strong>function</strong>å†…éƒ¨å®šä¹‰çš„å˜é‡çš„èƒ½åŠ›ï¼Œå¦‚åµŒå¥—<strong>function</strong>ä¸­çš„å­<strong>function</strong>å¯ä»¥è®¿é—®åˆ°å®šä¹‰åœ¨çˆ¶<strong>function</strong>ä¸­çš„å˜é‡ï¼Œæ˜¯ä¸€ç±»è¯­è¨€ï¼ˆå¦‚<strong>js</strong>ï¼‰çš„ç‰¹æ€§ã€‚</p> <span id="more"></span><h2 id="é—­åŒ…çš„åº”ç”¨"><a href="#é—­åŒ…çš„åº”ç”¨" class="headerlink" title="é—­åŒ…çš„åº”ç”¨"></a>é—­åŒ…çš„åº”ç”¨</h2><p>çœ‹ä¸€ä¸ªé—­åŒ…åœ¨<strong>js</strong> forå¾ªç¯ä¸­ç»å…¸çš„åº”ç”¨ï¼š</p><pre class="line-numbers language-none"><code class="language-none">function foo(){for(var i = 0; i&lt;10; i++){(function(j){setTimeout(function(){console.log( "current i:" + j + "--" + new Date().getSeconds() + "s" );}, j * 1000);})(i);    }}foo();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ä»£ç æ”¹è‡ª<em>Pro JavaScript Techniques</em> ä¸­ç”¨jsæ§åˆ¶cssè¾¾åˆ°åŠ¨ç”»æ•ˆæœçš„éƒ¨åˆ†ã€‚åŠ¨ç”»çš„é«˜åº¦/é€æ˜åº¦æ˜¯æ ¹æ®ç´¢å¼•<code>i</code>çš„å€¼åŠ¨æ€è®¾ç½®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªç´¢å¼•<code>i</code>ä¿å­˜ä¸‹æ¥ã€‚</p><h2 id="é—­åŒ…çš„é”™è¯¯ä½¿ç”¨"><a href="#é—­åŒ…çš„é”™è¯¯ä½¿ç”¨" class="headerlink" title="é—­åŒ…çš„é”™è¯¯ä½¿ç”¨"></a>é—­åŒ…çš„é”™è¯¯ä½¿ç”¨</h2><p>è¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬å†™æˆä¸‹é¢çš„ä»£ç å°±ä¸èƒ½å¾—åˆ°æ­£ç¡®çš„ç´¢å¼•å‘¢ï¼Ÿ</p><pre class="line-numbers language-none"><code class="language-none">function foo(){for(var i = 0; i&lt;10; i++){setTimeout(function(){console.log("current i:"+i+"--"+new Date().getSeconds()+"s");     //è¿™é‡Œä¹Ÿç”¨åˆ°äº†é—­åŒ…},i*1000);    }}foo();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ä»£ç å¾—åˆ°çš„<code>i</code>å§‹ç»ˆæ˜¯<strong>10</strong>ï¼Œè€Œä¸æ˜¯æƒ³è¦çš„<strong>1</strong>,<strong>2</strong>,<strong>3</strong>â€¦</p><p>ç°åœ¨æˆ‘ä»¬æ¥é€æ­¥è¯¦ç»†åˆ†æåŸå› :</p><ul><li><ol><li>è¿›å…¥<strong>foo</strong>çš„<strong>execution context</strong>é˜¶æ®µï¼š</li></ol></li></ul><p>è¿™æ—¶åˆ›å»º<strong>foo</strong>çš„<strong>Variable Object (VO)</strong>/<strong>Activation Object (AOï¼‰</strong></p><pre><code>    VO(foo) = {          i: undefined,    };</code></pre><ul><li><ol start="2"><li>fooä»£ç æ‰§è¡Œé˜¶æ®µï¼š</li></ol></li></ul><p>å°†<strong>fooExecutionContext</strong> pushè¿›<strong>Execution Context Stack</strong> ä¸­ï¼Œ<code>i</code>éšç€å¾ªç¯è¢«ä¿®æ”¹ä¸ºç›¸åº”çš„æ•°å€¼ã€‚</p><pre><code>    executionContextStack.push(fooExecutionContext);    executionContextStack = [         &lt;foo&gt; functionContext,        globalContext    ]</code></pre><p>ç”±äºåœ¨<code>for</code>å¾ªç¯æ‰§è¡Œçš„æ—¶å€™ï¼Œ<code>setTimeout</code>å†…éƒ¨çš„åŒ¿åå‡½æ•°çš„<strong>execution context</strong>å¯¹äº<strong>foo</strong>æ¥è¯´æ˜¯ä¸å¯è§çš„ï¼Œå› ä¸ºè¿™æ—¶çš„åŒ¿åå‡½æ•°å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œ ä¸èƒ½è®¿é—®ã€ä¿®æ”¹è¯¥åŒ¿åå‡½æ•°å†…éƒ¨çš„å˜é‡ï¼Œæ‰€ä»¥åŒ¿åå‡½æ•°ä¸­çš„<code>i</code>ä¸ä¼šè¢«ä¿®æ”¹ä¸º<code>for</code>å¾ªç¯çš„å½“å‰ç´¢å¼•ã€‚ ä½†æ˜¯è¯¥åŒ¿åå‡½æ•°çš„<strong>Variable Object (VO)</strong>/<strong>Activation Object (AO)<strong>å·²ç»åˆ›å»ºï¼Œå¹¶ä¸”ä¿å­˜äº†<code>i</code>çš„</strong>å¼•ç”¨</strong>ã€‚</p><p><code>for</code>å¾ªç¯ç»“æŸæ—¶<code>i</code>å€¼ä¸º<strong>10</strong>ï¼Œ æ­£æ˜¯ç”±äºåŒ¿åå‡½æ•°çš„<strong>VO</strong>/<strong>AO</strong>ä¿å­˜äº†<code>i</code>çš„<strong>å¼•ç”¨</strong>ï¼Œ<strong>foo</strong>è¿è¡Œç»“æŸæ—¶ï¼Œ<strong>Garbage Collector</strong>ä¸ä¼šé”€æ¯<strong>foo</strong>çš„<strong>VO</strong>/<strong>AO</strong>(ä¸Šé¢ä¿å­˜ç€<code>i=10</code>),æ‰€ä»¥å½“<code>setTimeout</code>å†…çš„åŒ¿åå‡½æ•°è¿è¡Œæ—¶ï¼Œ<code>i</code>çš„å€¼å§‹ç»ˆä¸º<strong>10</strong>ã€‚</p><p>ææ¸…æ¥šäº†ä¸Šé¢çš„é—®é¢˜åï¼Œç°åœ¨æˆ‘ä»¬ç”¨å›¾æ¥è§£é‡Šå¼€å§‹çš„ä¾‹å­ã€‚</p><p><img src="/img/javascript_scopechain_pic_1.png" alt="å›¾1"></p><p>ä¸Šé¢çš„å›¾æ˜¯fooåœ¨æ‰§è¡Œæœ€åä¸€æ¬¡å¾ªç¯æ—¶çš„è¿è¡Œæœºç†ã€‚</p><p><img src="/img/javascript_scopechain_pic_2.png" alt="å›¾2"></p><p>å›¾2æ˜¯<code>setTimeout</code>å†…éƒ¨åŒ¿åå‡½æ•°æ‰§è¡Œæ—¶çš„æœºç†ï¼Œå…¶ä¸­çº¢é¢œè‰²æ¡†èµ·æ¥éƒ¨åˆ†éšæ¯ä¸ª<code>setTimeout</code>å†…éƒ¨åŒ¿åå‡½æ•°çš„ä¸åŒè€Œä¸åŒã€‚</p><p>é€šè¿‡ä¸Šé¢ä¸¤å‰¯å›¾æˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œå¢åŠ çš„åŒ¿åè‡ªæ‰§è¡Œå‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†<code>for</code>å¾ªç¯çš„ç´¢å¼•ä½œä¸ºè‡ªå·±çš„å±€éƒ¨å˜é‡ä¿å­˜èµ·æ¥ï¼Œè¿™æ ·<code>setTimeout</code>é‡Œé¢çš„åŒ¿åå‡½æ•°å°±å¯ä»¥é€šè¿‡<strong>scope chain</strong>è®¿é—®åˆ°æ­£ç¡®çš„ç´¢å¼•å€¼äº†ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://dmitrysoshnikov.com/ecmascript/javascript-the-core/">http://dmitrysoshnikov.com/ecmascript/javascript-the-core/</a></p><p><a href="http://dmitrysoshnikov.com/ecmascript/chapter-1-execution-contexts/">http://dmitrysoshnikov.com/ecmascript/chapter-1-execution-contexts/</a></p><p><a href="http://dmitrysoshnikov.com/ecmascript/chapter-2-variable-object/">http://dmitrysoshnikov.com/ecmascript/chapter-2-variable-object/</a></p><p><a href="http://dmitrysoshnikov.com/ecmascript/chapter-4-scope-chain/">http://dmitrysoshnikov.com/ecmascript/chapter-4-scope-chain/</a></p><p>è¿ç§»è‡ªæ—§åšå®¢<a href="http://lwn.iteye.com/blog/1604548">æ‡’èœ—ç‰›</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vo </tag>
            
            <tag> closure </tag>
            
            <tag> scopechain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>androidä¸åŒç³»ç»Ÿç‰ˆæœ¬sdçš„æŒ‚è½½æ–¹å¼</title>
      <link href="/2014/10/31/android-sdcard-mounting-method/"/>
      <url>/2014/10/31/android-sdcard-mounting-method/</url>
      
        <content type="html"><![CDATA[<h2 id="2-xç³»ç»Ÿ"><a href="#2-xç³»ç»Ÿ" class="headerlink" title="2.xç³»ç»Ÿ"></a>2.xç³»ç»Ÿ</h2><p>sdå¡å®é™…æŒ‚è½½ä½ç½®</p><pre><code>    /mnt/sdcard </code></pre><p>å¹¶å»ºç«‹äº†ä¸€ä¸ª/sdcardçš„è½¯é“¾æ¥æŒ‡å‘/mnt/sdcard</p><pre><code>    /sdcard/  --&gt; /mnt/sdcard</code></pre><p><strong>Android 2.2ä¹‹åçš„ç‰ˆæœ¬å…è®¸å°†åº”ç”¨ç¨‹åºå®‰è£…äºSDå¡</strong></p><p>å½“SDå¡æŒ‚è½½äºæ‰‹æœºæ—¶ï¼Œ<code>/mnt/sdcard/.android_secure</code> ç›®å½•ä¼šè¢«æ˜ å°„åˆ°<code>/mnt/asec</code> ç›®å½•å’Œ <code>/mnt/secure</code> ç›®å½•ã€‚å…¶ä¸­<code>/mnt/asec</code> ç›®å½•ä¸­ä¸»è¦æ˜¯ç¨‹åºçš„å®‰è£…ç›®å½•ï¼ŒåŒ…æ‹¬å…¶æ‰§è¡Œæ–‡ä»¶å’Œlibæ–‡ä»¶ç­‰ï¼›è€Œ<code>/mnt/secure</code> ç›®å½•ä¸­å°±å­˜æ”¾ç¨‹åºåŠ å¯†åçš„æ¡£æ¡ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨<code>/mnt</code>è·¯å¾„ä¸‹çœ‹åˆ°çš„<code>/mnt/asec</code>ç›®å½•å’Œ<code>/mnt/secure</code>ç›®å½•å¹¶ä¸æ˜¯çœŸæ­£å­˜åœ¨åœ¨æ‰‹æœºå†…å­˜é‡Œçš„ï¼Œå®ƒä»¬åªæ˜¯<code>/mnt/sdcard/.android_secure</code>ç›®å½•çš„ä¸€ä¸ªå½±åƒè€Œå·²ã€‚ä¹Ÿå°±æ˜¯è¯´<code>/mnt/sdcard/.android_secure</code> =<code>/mnt/secure</code> +<code>/mnt/asec</code></p> <span id="more"></span><h2 id="4-1-ç³»ç»Ÿ"><a href="#4-1-ç³»ç»Ÿ" class="headerlink" title="4.1 ç³»ç»Ÿ"></a>4.1 ç³»ç»Ÿ</h2><ul><li><p>æœ‰å¤–ç½®sdå¡æ—¶ï¼Œå®é™…æŒ‚è½½ä½ç½®ï¼š</p><pre><code>  /storage/sdcard0  sdcard_r ç»„</code></pre><p>  ä¸ºäº†å…¼å®¹2.xç³»ç»Ÿappï¼Œä½¿æ—§çš„appèƒ½æ­£ç¡®è®¤å‡ºsdå¡ï¼Œå°†2.xæ—¶ä»£çš„sdå¡è·¯å¾„æ˜ å°„åˆ°<code>/storage/sdcard0</code>ä¸Š</p><pre><code>  /mnt/sdcard --&gt; /storage/sdcard0  systemç»„  /sdcard/ --&gt; /storage/sdcard0  rootç»„</code></pre></li><li><p>æ— å¤–ç½®sdå¡æ—¶ï¼Œå°†å†…éƒ¨å­˜å‚¨ç©ºé—´åˆ’åˆ†ä¸€éƒ¨åˆ†ï¼Œè™šæ‹Ÿä¸ºsdå¡æŒ‚è½½åœ¨ï¼š</p><pre><code>  /storage/sdcard0  sdcard_rwç»„  // å…¼å®¹2.xç³»ç»Ÿapp  /mnt/sdcard --&gt;  /storage/sdcard0 rootç»„  /sdcard/ --&gt; /storage/sdcard0  rootç»„</code></pre></li></ul><h2 id="4-4-2-ç³»ç»Ÿ"><a href="#4-4-2-ç³»ç»Ÿ" class="headerlink" title="4.4.2 ç³»ç»Ÿ"></a>4.4.2 ç³»ç»Ÿ</h2><p>sdå¡å®é™…æŒ‚è½½ä½ç½®</p><pre><code>    /mnt/shell/emulate/0</code></pre><p>å…¼å®¹2.xç³»ç»Ÿappï¼Œgoogleå±…ç„¶å°†ä»¥å‰çš„sdå¡æŒ‚è½½è·¯å¾„ç§°ä¸º<a href="http://translate.google.cn/?hl=en#en/zh-CN/legacy">legacy</a>ï¼Œå¯è§å¯¹å†å²åŒ…è¢±ä¹Ÿæ˜¯å¾ˆå¤´ç–¼</p><pre><code>    /storage/emulated/legacy  --&gt; /mnt/shell/emulate/0    /mnt/sdcard --&gt; /storage/emulated/legacy    /sdcard --&gt; /storage/emulated/legacy    /storage/sdcard0 --&gt; /storage/emulated/legacy</code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://stackoverflow.com/questions/23625104/storage-emulated-legacy-vs-storage-emulated-0-vs-data-data-myapp">http://stackoverflow.com/questions/23625104/storage-emulated-legacy-vs-storage-emulated-0-vs-data-data-myapp</a><br><a href="http://www.miui.com/thread-863099-1-1.html">http://www.miui.com/thread-863099-1-1.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sdcard </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¯¹javascriptä¸­çš„Variable Objectçš„ç†è§£</title>
      <link href="/2014/10/31/javascript-variable-object/"/>
      <url>/2014/10/31/javascript-variable-object/</url>
      
        <content type="html"><![CDATA[<h2 id="Variable-Object"><a href="#Variable-Object" class="headerlink" title="Variable Object"></a>Variable Object</h2><p>åœ¨<strong>ECMAScipt</strong>ä¸­ï¼Œé€šè¿‡å˜é‡å¯¹è±¡<strong>Variable Object (VO)<strong>æœºåˆ¶æ¥å­˜è´®ã€è®¿é—®å˜é‡variablesã€‚</strong>VO</strong>ä¸­åŒ…å«äº†ï¼š</p><h3 id="1-variables-é€šè¿‡var-å£°æ˜çš„å˜é‡"><a href="#1-variables-é€šè¿‡var-å£°æ˜çš„å˜é‡" class="headerlink" title="1.  variables (é€šè¿‡var å£°æ˜çš„å˜é‡)"></a>1.  variables (é€šè¿‡var å£°æ˜çš„å˜é‡)</h3><h3 id="2-function-declaration-å‡½æ•°å£°æ˜"><a href="#2-function-declaration-å‡½æ•°å£°æ˜" class="headerlink" title="2.  function declaration (å‡½æ•°å£°æ˜)"></a>2.  function declaration (å‡½æ•°å£°æ˜)</h3><h3 id="3-function-formal-parameters-å‡½æ•°è¡Œå‚"><a href="#3-function-formal-parameters-å‡½æ•°è¡Œå‚" class="headerlink" title="3.  function formal parameters (å‡½æ•°è¡Œå‚)"></a>3.  function formal parameters (å‡½æ•°è¡Œå‚)</h3><p><strong>æ³¨</strong>ï¼š ä¸åŒ…æ‹¬function expression (å‡½æ•°è¡¨è¾¾å¼)ã€‚</p> <span id="more"></span><p><strong>Variable Object</strong>åœ¨<strong>Global Context</strong>ä¸­ç­‰åŒäº<strong>Global Object</strong>ï¼Œåœ¨<strong>Function Context</strong>ä¸­ç§°ä¸º<strong>Activation Object (AO)<strong>ï¼Œ<br>ä¸€èˆ¬æ¥è®²ï¼Œ</strong>Variable Object</strong> / <strong>Activation Object</strong> æˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨å¤–éƒ¨è®¿é—®åˆ°ã€‚</p><p>è¦è®¿é—®æŸä¸ªå˜é‡<strong>x</strong>ï¼Œé¦–å…ˆåœ¨<strong>x</strong>æ‰€åœ¨<strong>Function Context</strong>ä¸­çš„<strong>Variable Object</strong>ä¸­æŸ¥æ‰¾ï¼Œ<br>è‹¥æ‰¾ä¸åˆ°ï¼Œåˆ™åœ¨<strong>x</strong>æ‰€å±<strong>function</strong>çš„<strong>[[scope]]<strong>å±æ€§ä¸­ä¿å­˜çš„</strong>scope chain</strong>ä¸­ï¼Œ<br>é€çº§å‘ä¸ŠæŸ¥æ‰¾ï¼Œç›´è‡³æŸ¥æ‰¾åˆ°<strong>Global Object</strong>ï¼Œå¦‚æœä»æœªæ‰¾åˆ°åˆ™è¿”å› <strong>x</strong> is not defined ã€‚</p><p>æˆ‘ä»¬æ‰€å¸¸è§çš„<code>window</code>å¯¹è±¡å®é™…ä¸Šæ˜¯<strong>Global Object</strong>çš„å¼•ç”¨ï¼Œæ‰€ä»¥é€šè¿‡<code>var</code>åœ¨<strong>Global Context</strong>ä¸­å£°æ˜çš„å˜é‡<strong>x</strong>ï¼Œ<br>å¯ä»¥é€šè¿‡<strong>x</strong>ç›´æ¥è®¿é—®ï¼Œä¹Ÿå¯é€šè¿‡<code>window.x</code>æ¥é—´æ¥è®¿é—®ï¼Œå¹¶ä¸”<a href="http://www.cnblogs.com/TomXu/archive/2012/01/16/2309728.html#2296024">é€šè¿‡<code>window.x</code>è®¿é—®æ¯”ç›´æ¥è®¿é—®è¦æ…¢</a> ã€‚</p><pre><code>    var a = "variable";    b = "property";    console.log(window.a);  // "variable"    console.log(window.b); // "property"    delete window.a;  // false    console.log(window.a); // "variable"    delete window.b; //true    console.log(window.b);  //undefined;</code></pre><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ è™½ç„¶éƒ½èƒ½é€šè¿‡<code>window.a</code>, <code>window.b</code>çš„å½¢å¼æ¥è®¿é—®ï¼Œçœ‹ä¼¼éƒ½æ˜¯<code>window</code>çš„å±æ€§ï¼Œä½†æ˜¯å®è´¨æ˜¯ä¸åŒçš„ã€‚</p><p>ä¸ä½¿ç”¨<code>var</code>å£°æ˜çš„â€å˜é‡â€œï¼Œå®é™…ä¸æ˜¯çœŸæ­£çš„å˜é‡ï¼Œè€Œæ˜¯<strong>Global Object</strong>çš„å±æ€§ï¼Œå¯ä»¥é€šè¿‡<strong>delete</strong> å…³é”®å­—åˆ é™¤ï¼Œè€ŒçœŸæ­£çš„å˜é‡æ‹¥æœ‰<code>DontDelete</code>å±æ€§ï¼Œä¸èƒ½é€šè¿‡<code>delete</code>åˆ é™¤ã€‚</p><p>ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨firebugä¸­ï¼Œæ‰§è¡Œ</p><pre><code>    delete window.a;  //true    delete window.b;  //true</code></pre><p>è¿”å›å€¼éƒ½æ˜¯<strong>true</strong>ï¼Œè¿™æ˜¯ç”±äºåœ¨eval contextä¸­ï¼Œå˜é‡ä¸ä¼šè¢«æ·»åŠ <code>DontDelete</code>å±æ€§ï¼Œfirebugæ­£æ˜¯åˆ©ç”¨evalæ¥æ‰§è¡Œæˆ‘ä»¬åœ¨consoleä¸­çš„ä»£ç ï¼Œè€Œåœ¨chromeï¼Œoperaçš„consoleä¸­åˆ™è¿”å›æ­£ç¡®çš„<strong>false</strong>,<strong>true</strong></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://dmitrysoshnikov.com/ecmascript/chapter-2-variable-object/">http://dmitrysoshnikov.com/ecmascript/chapter-2-variable-object</a></p><p>è¿ç§»è‡ªæ—§åšå®¢<a href="http://lwn.iteye.com/blog/1602643">æ‡’èœ—ç‰›</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> vo </tag>
            
            <tag> scope chain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>canvasã€bitmapã€paintä¹‹é—´æ˜¯ä»€ä¹ˆå…³ç³»</title>
      <link href="/2014/04/12/canvas/"/>
      <url>/2014/04/12/canvas/</url>
      
        <content type="html"><![CDATA[<p><a href="http://developer.android.com/reference/android/graphics/Canvas.html">å®˜æ–¹æ–‡æ¡£</a>ç¿»è¯‘è¿‡æ¥çš„è§£é‡Šï¼š</p><p>è¦ç»˜å›¾ï¼Œéœ€è¦4ä¸ªåŸºæœ¬ç»„ä»¶:</p><ul><li>Bitmap ä¿å­˜åƒç´ çš„å®¹å™¨</li><li>Canvas æ‰§è¡Œç»˜å›¾å‘½ä»¤çš„å®¿ä¸»</li><li>Rect/Path/text/Bitmap è¦ç»˜åˆ¶çš„å…ƒç´ </li><li>Paint ç”¨ä»€ä¹ˆæ ·çš„æ–¹å¼ç»˜åˆ¶</li></ul><p>androidçš„<strong>canvas</strong>ç»˜å›¾ï¼ŒåŸºäº<strong>skia</strong>ï¼Œæƒ³è¦äº†è§£<strong>canvas</strong>çš„ç»˜å›¾è¿‡ç¨‹ï¼Œéœ€è¦å¯¹<strong>canvas</strong>å’Œ<strong>skia</strong>çš„æºç æœ‰æ‰€äº†è§£ã€‚</p><p>æŸ¥çœ‹Canvasæºç ï¼Œå‘ç°Canvasä¸Bitmapç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹å…¶nativeæ–¹æ³•è¿›è¡Œäº†å°è£…ã€‚</p> <span id="more"></span><p>çœŸæ­£èµ·ç»˜å›¾ä½œç”¨çš„æ˜¯<code>mNativeCanvas</code>ï¼Œä¿å­˜æœ‰**nativeCanvas(SkCanvas)**çš„æŒ‡é’ˆã€‚</p><p><code>mNativeCanvas</code>æ³¨é‡Šä¸ŠæŒ‡æ˜</p><blockquote><p> assigned in constructors or setBitmap, freed in finalizer</p></blockquote><p>è¯´æ˜<code>mNativeCanvas(SkCanvas)</code>æ˜¯åœ¨æ„é€ å‡½æ•°ã€æˆ–è€…<code>setBitmap</code>æ—¶åˆ†é…çš„ã€‚</p><p>ç»§ç»­æŸ¥çœ‹æºç ï¼Œå‘ç°<code>mNativeCanvas</code>æ˜¯è°ƒç”¨<strong>native</strong>æ–¹æ³•</p><pre><code>initRaster(int nativeBitmapOrZero)</code></pre><p>æ–¹æ³•ç”Ÿæˆã€‚</p><p><code>initRaster</code>ä¸­çš„å‚æ•°å°±æ˜¯Canvasç§æœ‰å±æ€§<code>mBitmap</code>çš„**nativeBitmap(SkBitmap)**çš„æŒ‡é’ˆã€‚</p><p>æŸ¥çœ‹*frameworks/base/core/jni/android/graphics/*ä¸‹çš„Canvas.cppæ–‡ä»¶ï¼Œ</p><pre><code>static SkCanvas* initRaster(JNIEnv* env, jobject, SkBitmap* bitmap) {        return bitmap ? new SkCanvas(*bitmap) : new SkCanvas;}</code></pre><p>å‘ç°å¦‚æœæŒ‡å®šäº†<strong>SkBitmap</strong>ï¼Œ<code>initRaster</code>ä¼šä»¥æŒ‡å®šçš„<strong>SkBitmap</strong>ç”Ÿæˆ<strong>SkCanvas</strong>ï¼›</p><p>åä¹‹ä¼šç”Ÿæˆé»˜è®¤çš„<strong>SkCanvas</strong>ã€‚</p><p>ç»§ç»­æŸ¥çœ‹*android/external/skia/src/core/*ä¸‹SkCanvasçš„æºç ï¼Œ</p><p>é»˜è®¤æ„é€ å‡½æ•°</p><pre><code>SkCanvas::SkCanvas(): fMCStack(sizeof(MCRec), fMCRecStorage, sizeof(fMCRecStorage)) {    inc_canvas();        this-&gt;init(NULL);}</code></pre><p><code>init</code>æ–¹æ³•è°ƒç”¨<code>setDevice</code>æ–¹æ³•ï¼Œç”Ÿæˆé»˜è®¤çš„<strong>SkDevice</strong>ï¼Œè€Œ<strong>SkDeveice</strong>æœ€ç»ˆä¼šç”Ÿæˆé»˜è®¤çš„<strong>SkBitmap</strong></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li><p>Canvasçš„å±æ€§<code>mNativeCanvas(SkCanvas)</code>æ˜¯æ ¹æ®<code>mBitmap</code>ç”Ÿæˆçš„ï¼Œå¦‚æœ<code>mBitmap</code>ä¸ä¸ºç©ºï¼Œ</p><p>åˆ™<code>mNativeCanvas</code>æ“ä½œ/ä¿®æ”¹çš„<strong>SkBitmap</strong>å°±æ˜¯<code>mBitmap</code>ï¼›</p><p>å¦åˆ™ä¼šæ“ä½œ/ä¿®æ”¹<code>mNativeCanvas</code>è‡ªå·±çš„<strong>SkBitmap</strong>.</p></li><li><p>Canvasæœ€ç»ˆæ“ä½œ/ä¿®æ”¹çš„å†…å­˜è¿˜æ˜¯**Bitmap(SkBitmap)**ä¸­çš„æ•°æ®.</p></li><li><p><code>Canvas(bitmap)</code> ä¸ <code>canvas.setBitmap(bitmap)</code>ä¸­çš„<strong>bitmap</strong>æ˜¯Canvasçš„<code>mBitmap</code>ï¼Œç›´æ¥æ“ä½œ/ä¿®æ”¹çš„å¯¹è±¡ã€‚</p><p><code>canvas.drawBitmap(bitmap)</code>ä¸­çš„<strong>bitmap</strong>æ˜¯æº<strong>bitmap</strong>ï¼Œdrawæ—¶ï¼Œä¸å¯¹æº<strong>bitmap</strong>è¿›è¡Œå†™æ“ä½œï¼Œ</p><p>è€Œæ˜¯å†™å…¥åˆ°<code>mBitmap</code>æˆ–<code>mNativeCanvas</code>è‡ªå·±çš„<strong>SkBitmap</strong>ä¸­ã€‚</p></li><li><p>æºç ä¸­æŒ‡æ˜Canvasæœ€å¤§ç»˜å›¾å¤§å°ä¸º<strong>32766 * 32766</strong>ã€‚è¶…è¿‡è¿™ä¸ªå¤§å°ä¼šç›´æ¥æŠ¥é”™ã€‚</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> canvas </tag>
            
            <tag> bitmap </tag>
            
            <tag> paint </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Drawableå°ç ”ç©¶</title>
      <link href="/2014/04/12/drawable/"/>
      <url>/2014/04/12/drawable/</url>
      
        <content type="html"><![CDATA[<p>Drawableï¼Œå®˜æ–¹ç»™å‡ºçš„è§£é‡Šæ˜¯â€œ<em>something that can be drawn</em>â€ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯å¯ä»¥è¢«ç”»çš„ä¸œè¥¿ã€‚</p><p>å®˜æ–¹æŠŠâ€œå¯ä»¥è¢«ç”»çš„ä¸œè¥¿â€åˆ†ä¸ºäº†7ç§å½¢å¼:</p><ul><li><p><a href="../../11/bitmap">Bitmap</a> æœ€ç®€å•çš„â€œå¯ä»¥è¢«ç”»çš„ä¸œè¥¿â€ï¼Œå¯èƒ½æ˜¯pngï¼Œæˆ–jpg</p></li><li><p><strong>Nine Patch</strong> ä¿—ç§°â€œ.9â€å›¾ï¼Œandroidè‡ªå·±æ‰©å±•çš„ä¸€ç§pngæ ¼å¼ï¼Œå¯ä»¥è‡ªå®šä¹‰å›¾åƒæ‹‰ä¼¸çš„ä¿¡æ¯</p></li><li><p><strong>Shape</strong> ç”¨ç®€å•çš„ç»˜å›¾æŒ‡ä»¤ç”Ÿæˆå›¾ç‰‡ã€‚å¦‚ç”»çŸ©å½¢ã€åœ†å½¢</p></li><li><p><strong>Layers</strong> å¤šä¸ªDrawableï¼ŒæŒ‰ç…§å±‚å é¡ºåºç»„æˆçš„Drawable</p></li><li><p><strong>States</strong> Drawableçš„çŠ¶æ€ï¼Œå¦‚â€œfocusedâ€, â€œpressedâ€ç­‰</p></li><li><p><strong>Levels</strong> å¯ä»¥æ›´æ”¹levelçš„Drawableï¼Œå¦‚è¿›åº¦æ¡ï¼Œç”µæ± è¿›åº¦</p></li><li><p><strong>Scale</strong> å¯ç¼©æ”¾çš„Drawable</p></li></ul> <span id="more"></span><p>Drawableæ˜¯æ‰€æœ‰XDrawableçš„çˆ¶ç±»ï¼Œå­ç±»æœ‰AnimationDrawableã€BitmapDrawableã€ClipDrawableã€<br>GradientDrawableã€InsetDrawableã€LayerDrawableã€LevelListDrawableã€NinePathDrawableã€<br>PaintDrawableã€PictureDrawbleã€RotateDrawableã€ScaleDrawableã€ShapeDrawableã€StateListDrawableã€<br>TransitionDrawableã€‚</p><p><strong>æ‰€ä»¥ï¼ŒDrawableæ˜¯å¯¹ä¸€ç±»â€œå¯ä»¥è¢«ç”»â€çš„äº‹ç‰©çš„æŠ½è±¡ï¼ŒBitmapæ˜¯7ç§å½¢å¼Drawableçš„å…¶ä¸­ä¸€ç§ï¼ŒBitmapDrawableæ˜¯å¯¹Bitmapå°è£…çš„å…·ä½“Drawableã€‚</strong></p><p>Drawableå®šä¹‰äº†æŠ½è±¡æ–¹æ³•<code>draw(Canvas)</code>ï¼Œå„å­ç±»æ ¹æ®è‡ªå·±å…·ä½“ç‰¹å¾ï¼Œå®ç°ä¸åŒçš„drawæ–¹æ³•ã€‚</p><p>Drawableå¯ä»¥é€šè¿‡é™æ€æ–¹æ³•<code>creatFromResourceStream</code>åˆ›å»ºBitmapï¼Œä¹‹ååŒ…è£…ä¸ºBitmapDrawableï¼Œ</p><p>ä¹Ÿå¯ä»¥é€šè¿‡<code>createFromXmlInner</code>å·¥å‚æ–¹æ³•ï¼Œæ ¹æ®xmlæ–‡ä»¶å†…å®¹åˆ›å»ºå…·ä½“çš„Drawableå­ç±»ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bitmap </tag>
            
            <tag> drawable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Bitmapçš„ä¸€ç‚¹ç ”ç©¶</title>
      <link href="/2014/04/10/bitmap/"/>
      <url>/2014/04/10/bitmap/</url>
      
        <content type="html"><![CDATA[<p>androidä¸­çš„<strong>Bitmap</strong>ä¸å…¶ä»–å¯¹è±¡ä¸åŒï¼Œä¸èƒ½é€šè¿‡<code>new Bitmap()</code>ç›´æ¥å®ä¾‹åŒ–.</p><p>æŸ¥çœ‹æºç ï¼Œ<strong>Bitmap</strong>çš„æ„é€ å‡½æ•°æ˜¯<em>default</em>çš„ï¼Œä»…åŒ…å†…å¯è§ï¼Œå®é™…æ˜¯ä¾›<strong>native</strong>æ–¹æ³•è°ƒç”¨çš„ã€‚</p><p><strong>Bitmap</strong>ä¸­å®é™…ä¿å­˜æ•°æ®çš„åœ°æ–¹åœ¨<strong>native</strong>å±‚ï¼Œ<strong>java</strong>å±‚ä»…å¯¹<strong>native</strong>å±‚æ–¹æ³•è¿›è¡Œå°è£…ã€é‡è½½ï¼Œ</p><p>å¹¶æä¾›ä¸€äº›çŠ¶æ€çš„åˆ¤æ–­æ–¹æ³•ã€å±æ€§çš„<code>set</code>ã€<code>get</code>æ–¹æ³•ã€‚</p><p><strong>Bitmap</strong>æœ‰<code>mNativaBitmap</code>å±æ€§ï¼Œç”¨æ¥ä¿å­˜<code>nativeBitmap</code>çš„åœ°å€ã€‚</p><p><code>mNativeBitmap</code>çš„åœ°å€åœ¨æ„é€ <strong>Bitmap</strong>æ—¶ï¼Œç”±<strong>native</strong>æ–¹æ³•ç›´æ¥ä¼ é€’è¿›æ¥ã€‚</p><p>####æ‰€ä»¥æ•´ä¸ª<strong>Bitmap</strong>å¯ä»¥è®¤ä¸ºåœ¨<strong>java</strong>å±‚åŸºæœ¬ä¸æ€ä¹ˆå å†…å­˜ï¼Œå¤§éƒ¨åˆ†å†…å­˜å ç”¨éƒ½æ˜¯åœ¨<strong>native</strong>å±‚ã€‚</p> <span id="more"></span><h3 id="Bitmapè‡ªèº«æä¾›äº†ä¸‰ç±»åˆ›å»ºBitmapçš„é™æ€æ–¹æ³•ï¼š"><a href="#Bitmapè‡ªèº«æä¾›äº†ä¸‰ç±»åˆ›å»ºBitmapçš„é™æ€æ–¹æ³•ï¼š" class="headerlink" title="Bitmapè‡ªèº«æä¾›äº†ä¸‰ç±»åˆ›å»ºBitmapçš„é™æ€æ–¹æ³•ï¼š"></a><strong>Bitmap</strong>è‡ªèº«æä¾›äº†ä¸‰ç±»åˆ›å»º<strong>Bitmap</strong>çš„é™æ€æ–¹æ³•ï¼š</h3><h4 id="1-æ ¹æ®ä¼ å…¥çš„colorsæ•°ç»„ï¼Œç”Ÿæˆbitmapï¼Œcolorsæ•°ç»„å°±æ˜¯æ¯ä¸ªåƒç´ ç‚¹çš„é¢œè‰²å€¼ARGB"><a href="#1-æ ¹æ®ä¼ å…¥çš„colorsæ•°ç»„ï¼Œç”Ÿæˆbitmapï¼Œcolorsæ•°ç»„å°±æ˜¯æ¯ä¸ªåƒç´ ç‚¹çš„é¢œè‰²å€¼ARGB" class="headerlink" title="1. æ ¹æ®ä¼ å…¥çš„colorsæ•°ç»„ï¼Œç”Ÿæˆbitmapï¼Œcolorsæ•°ç»„å°±æ˜¯æ¯ä¸ªåƒç´ ç‚¹çš„é¢œè‰²å€¼ARGB"></a>1. æ ¹æ®ä¼ å…¥çš„<code>colors</code>æ•°ç»„ï¼Œç”Ÿæˆ<code>bitmap</code>ï¼Œ<code>colors</code>æ•°ç»„å°±æ˜¯æ¯ä¸ªåƒç´ ç‚¹çš„é¢œè‰²å€¼ARGB</h4><pre><code>createBitmap(int colors[], int offset, int stride, int width, int height, Config config);</code></pre><p>æœ€ç»ˆè°ƒç”¨<strong>native</strong>æ–¹æ³•</p><pre><code>nativeCreate(int[] colors, int offset, int stride, int width. int height, int config.nativeInt, boolean false)</code></pre><p>ç”Ÿæˆæ–°çš„<strong>Bitmap</strong></p><h4 id="2-ç”ŸæˆæŒ‡å®šå¤§å°çš„ç©ºç™½Bitmap"><a href="#2-ç”ŸæˆæŒ‡å®šå¤§å°çš„ç©ºç™½Bitmap" class="headerlink" title="2.  ç”ŸæˆæŒ‡å®šå¤§å°çš„ç©ºç™½Bitmap"></a>2.  ç”ŸæˆæŒ‡å®šå¤§å°çš„ç©ºç™½<strong>Bitmap</strong></h4><pre><code>createBitmap(int width, int height, Config config)</code></pre><p>åŒæ ·æœ€ç»ˆä¼šè°ƒç”¨</p><pre><code>nativeCreate(int[] colors, int offset, int stride, int width. int height, int config.nativeInt, boolean false)</code></pre><p>ä¸è¿‡å…¶ä¸­<code>color</code>æ•°ç»„ä¸º<code>null</code></p><h4 id="3-ä»æºBitmapä¸­æˆªå–ä¸€éƒ¨åˆ†ï¼Œç”Ÿæˆæ–°çš„Bitmapï¼Œä¸å¯¹æºbitmapä¿®æ”¹"><a href="#3-ä»æºBitmapä¸­æˆªå–ä¸€éƒ¨åˆ†ï¼Œç”Ÿæˆæ–°çš„Bitmapï¼Œä¸å¯¹æºbitmapä¿®æ”¹" class="headerlink" title="3.  ä»æºBitmapä¸­æˆªå–ä¸€éƒ¨åˆ†ï¼Œç”Ÿæˆæ–°çš„Bitmapï¼Œä¸å¯¹æºbitmapä¿®æ”¹"></a>3.  ä»æºBitmapä¸­æˆªå–ä¸€éƒ¨åˆ†ï¼Œç”Ÿæˆæ–°çš„Bitmapï¼Œä¸å¯¹æºbitmapä¿®æ”¹</h4><p>å…·ä½“å®ç°åˆ†ä¸¤éƒ¨åˆ†ï¼š</p><p>è°ƒç”¨æ–¹æ³•<strong>ï¼ˆ2ï¼‰</strong>ç”Ÿæˆæ–°çš„ç©ºç™½bitmap</p><p>new ä¸€ä¸ªCanvasï¼Œå°†æ–°ç”Ÿæˆçš„bitmap setåˆ°canvasé‡Œï¼Œé€šè¿‡canvaså¯¹bitmapè¿›è¡Œè£å‰ªç­‰å¤„ç†ï¼Œç„¶åè¿”å›bitmap</p><pre><code>Canvas canvas = new Canvas();canvas.setBitmap(bitmap);canvas.drawBitmap(sourceBitmap, srcRect, dstRectF, paint);canvas.setBitmap(null);  //å°†ä¸´æ—¶çš„canvasä¸­çš„mBitmapç½®ç©ºï¼Œé˜²æ­¢canvasæ‹¥æœ‰bitmapå¼•ç”¨ï¼Œæ— æ³•è¢«GCå›æ”¶</code></pre>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> canvas </tag>
            
            <tag> bitmap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•åœ¨androidä¸ŠæŠ“åŒ…</title>
      <link href="/2014/03/20/how-to-view-network-requests-on-android/"/>
      <url>/2014/03/20/how-to-view-network-requests-on-android/</url>
      
        <content type="html"><![CDATA[<h2 id="ç”¨Charles"><a href="#ç”¨Charles" class="headerlink" title="ç”¨Charles"></a>ç”¨Charles</h2><p><strong>android4.0ä»¥ä¸Šçš„ç³»ç»Ÿï¼Œwifiç¯å¢ƒä¸‹æ”¯æŒè®¾ç½®ç½‘ç»œä»£ç†ã€‚</strong></p><ul><li><p>å®‰è£…<a href="http://www.charlesproxy.com/">Charles</a></p></li><li><p>æ‰“å¼€Charlesï¼Œåœ¨<code>proxy</code>â€“&gt;<code>proxy settings</code>â€“&gt;<code>proxies</code>ä¸­è®¾ç½®è¦ç›‘å¬çš„ç«¯å£å·ï¼Œä¸€èˆ¬ä¸º<strong>8080</strong></p></li><li><p>æŸ¥çœ‹æœ¬æœºipï¼Œ</p><pre><code>  $ ifconfig</code></pre></li><li><p>è®°ä½æœ¬æœºçš„ipåœ°å€ï¼Œå¦‚<strong>222.11.22.11</strong></p></li><li><p>å°†androidæ‰‹æœºè¿ä¸Šwifiï¼Œç¡®ä¿ä¸ç”µè„‘å¤„äº<strong>åŒä¸€</strong>ipæ®µã€‚</p></li><li><p>ä¸€èˆ¬åœ¨wifiè¿æ¥çš„<strong>é«˜çº§è®¾ç½®</strong>é‡Œå¯ä»¥æ‰¾åˆ°<strong>ä»£ç†è®¾ç½®</strong>ï¼Œå°†ä»£ç†è®¾ç½®æ”¹ä¸º<strong>æ‰‹åŠ¨</strong>ï¼Œ<br>å¡«å…¥åˆšæ‰è®°ä¸‹çš„ipåœ°å€ï¼Œä»¥åŠCharlesé‡Œè®¾ç½®çš„ç«¯å£å·<strong>8080</strong>ï¼Œä¿å­˜åé€€å‡ºã€‚<br>ç°åœ¨æ‰‹æœºçš„ç½‘ç»œè¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°Charlesä¸Šã€‚</p><span id="more"></span><p>  <img src="/img/charles.png" alt="charles"></p></li></ul><p> è¿™ç§æ–¹æ³•åªé€‚åˆäºæŠ“å»android4.0ä»¥ä¸Šç³»ç»Ÿï¼Œwifiç¯å¢ƒçš„ç½‘ç»œè¯·æ±‚ã€‚</p><p> å¯¹äºandroid2.xçš„ç³»ç»Ÿï¼Œç³»ç»Ÿæ²¡æœ‰æä¾›è®¾ç½®ä»£ç†çš„æ–¹æ³•ã€‚</p><p> æˆ–è€…ï¼Œæˆ‘ä»¬éœ€è¦æŸ¥çœ‹ <em>2g</em> / <em>3g</em> / <em>4g</em> çš„ç½‘ç»œè¯·æ±‚ï¼Œç”¨Chalerså°±æ— èƒ½ä¸ºåŠ›äº†ã€‚</p><hr><h2 id="ç”¨tcpdumpç»“åˆwireshark"><a href="#ç”¨tcpdumpç»“åˆwireshark" class="headerlink" title="ç”¨tcpdumpç»“åˆwireshark"></a>ç”¨tcpdumpç»“åˆwireshark</h2><p><strong>å‰ææ˜¯æ‰‹æœºè¦rootè¿‡</strong></p><p> <a href="http://www.tcpdump.org/">tcpdump</a>æ˜¯ä¸€ä¸ªå¼€æºè·¨å¹³å°çš„ç½‘ç»œæ•°æ®é‡‡é›†åˆ†æå·¥å…·ã€‚</p><p> è¯¦ç»†ç”¨æ³•å‚è§<a href="http://www.cnblogs.com/ggjucheng/archive/2012/01/14/2322659.html">ggjucheng</a>çš„åšå®¢ã€‚</p><ul><li><p>é¦–å…ˆä¸‹è½½<a href="http://www.strazzere.com/android/tcpdump">tcpdump</a></p></li><li><p>å°†<strong>tcpdump</strong> pushåˆ°æ‰‹æœºsdå¡ä¸Š</p><pre><code>  $ adb push ./tcpdump /sdcard/tcpdump</code></pre></li><li><p>ç”¨<strong>rootExplorer</strong>å°†<strong>tcpdump</strong>å¤åˆ¶åˆ°*/system/xbin*ç›®å½•ä¸‹</p></li><li><p>è·å–rootæƒé™</p><pre><code>  $ adb shell  $ su</code></pre></li><li><p>ç»™<strong>tcpdump</strong>åŠ ä¸Šæƒé™</p><pre><code>  $ chmod 777 /system/xbin/tcpdump</code></pre></li><li><p>ç„¶åå°±æ˜¯æ‰§è¡Œ<strong>tcpdump</strong>å¼€å§‹æŠ“åŒ…äº†</p><pre><code>  $ tcpdump -p -vv -s 0 -w /sdcard/cap.pcap</code></pre></li><li><p>ç­‰æ”¶é›†åˆ°è¶³å¤Ÿçš„æ•°æ®åŒ…å<strong>ctrl + c</strong>åœæ­¢æŠ“åŒ…</p></li><li><p>æŠŠæ”¶é›†åˆ°çš„æ•°æ®pullåˆ°æœ¬åœ°</p><pre><code>  $ adb pull /sdcard/cap.pcap ./</code></pre></li><li><p>ç”¨<strong>wireshark</strong>æ‰“å¼€<strong>pcap</strong>æ–‡ä»¶</p><p>  <img src="/img/wireshark.png" alt="wireshark"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tcpdump </tag>
            
            <tag> æŠ“åŒ… </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
